---
title: "Beavertail and InvisibleFerret malware"
date: 2024-08-12 20:00:00 -0700
categories: [Blogging]
tags: [ida, beavertail, invisibleferret]
---

## Summary
`FAMOUS CHOLLIMA`, active since 2018, is a low-sophistication adversary almost certainly operates on behalf of the `North Korean government (DPRK)`. The adversary primarily focuses on generating revenue through small-value cryptocurrency theft, credit card fraud, or illicit salaries via software development jobs. However, they can also exfiltrate data and may shift to intelligence collection or intellectual property theft if necessary.

The adversary uses custom malware families `BeaverTail` and `InvisibleFerret`, remote monitoring and management tools (RMMs), and malicious Node.js applications to deliver malware to victims. They also infiltrate corporate environments through malicious insiders, often hired as full-time equivalents directly or via contracting organizations. Despite their low sophistication, `FAMOUS CHOLLIMA` has displayed a high operational tempo and is expected to continue its activity in the foreseeable future with similar TTPs.

## High-level overview of malware infection
<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/00.png"/>

## Analysis
The malware manifests in the form of obfuscated JavaScript that is injected into NodeJS packages and application installers.  The sample that has been analyzed was found within the run.js file of a NodeJS application.

### Overview
The flow of activity on an infected device can be summarized as:
* User is lured into installing a malicious NodeJS package
* The NodeJS application executes obfuscated JavaScript
  * The embedded malicous JavaScript is the `BeaverTail` malware
* `BeaverTail` attempts to:
  * Steal browser credentials and crypto related files
  * Performs GET/POST's to:
    * `C2_IP:1244/keys`
    * `C2_IP:1244/uploads`
    * `C2_IP:1244/pdown`
    * `C2_IP:1244/client/N3RFYU07` (InvisibleFerret)
  * Downloads and executes `InvisibleFerret` malware
  * Downloads a python wheel package called "`pdown`"
    * [https://pypi.org/project/pdown/](https://pypi.org/project/pdown/)
    * "A command line tool to download periscope charts and save the snapshot of the chart with a timestamp to a local file. Allows for historical data to be
archived so that trends can be analyzed."
* `InvisibleFerret`
  * Collects system information, credentials, and installs a RAT
  * Exfiltrates information via Web, FTP, and Telegram
  * Performs GET/POST's to:
    * `C2_IP:1244/keys`
    * `C2_IP:1244/uploads`
    * `C2_IP:1244/brow/N3RFYU07`
    * `C2_IP:1244/adc`

### Analyzing the BeaverTail JavaScript
I downloaded the archive from VirusTotal that contains the malicious package. Upon decompressing it the extracted code was available for review.  The `README.md` explained what this was and where it was originally hosted on BitBucket.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/01.png"/>

The original location to clone from is seen in the install instructions below but does not appear to be currently available on BitBucket (at least not publicly).

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/02.png"/>

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/03.png"/>

The malicious obfuscated code was discovered in the run.js file and is executed upon the start of the NodeJS server. This appears to be the `BeaverTail` malware that starts the infection chain.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/04.png"/>

I performed the first phase of deobfuscation by running it through [https://deobfuscate.io](https://deobfuscate.io).  This doesn't really deobfuscate it as much as it helps to format it better so you can start analyzing the JavaScript.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/05.png"/>

Upon making it more readable I copied it back into the `run.js` script to be able to debug it. I tried to analyze it in several ways statically, but it performs quite a bit of dynamic calls and creation of anonymous functions.  In these cases, and due to the fact, it executes within the context of a NodeJS application I opted to understand it better dynamically.

**Debugging**<br />
To setup this up it was the process of:
* Installing NodeJS on FlareVM
* Executing "`npm install express`"
* Opening the code repo in vscode (after all the installs are complete)
* Replacing the embedded malicious JavaScript in run.js with the expanded version
* Setting up a breakpoint at the beginning of the malicious code
* Click `Run->Start Debugging`

The obfuscated code takes up `3.1Kb` of space within the file.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/06.png"/>

The process involved a lot of stepping into anonymous functions, resolving and decoding strings from a shifted string array, and modifying the JavaScript to run properly within a debugger.  There are several cases where I had to modify the malware code to not perform certain searches on the endpoint, disable anti-debug loops, and otherwise short circuit some logic to get to the calls to the C2.

The following screenshots illustrate some key parts of the malware code and areas that are worth talking about.

**The string array**<br />
An array of strings is rotated until an integer condition is met.  This array will be referenced later in the script as it pieces together these strings by index to make the script function. This is quite a common practice and seen routinely in obfuscated JavaScript.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/07.png"/>

The array of strings that are referenced can be found further down in the script. Throughout the remainder of the script these strings will be referenced by index.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/08.png"/>

A lot of these strings appear to be base64 encoded as well as some that are readily readable.  We can do a quick decode on them just to see what we get.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/09.png"/>

We can already get an idea from the start that it's going to be searching for browser data, keychain data, using curl and tar commands, etc. Later, we'll see that some of the base64 strings are appended together to decode properly but this gives us some initial context.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/10.png"/>

**Regex searches**<br />
The malware will perform regex searches that take quite a bit of time.  During debugging this will cause a hang for a period of time, and this was not needed to continue.  This can simply be changed to return immediately.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/11.png"/>

**Debugger checks**<br />
There are some debugger checks that we can also return out of immediately to allow the script to continue to run. In this case, if a debugger is found it will put you in a forever while-true loop.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/12.png"/>

**C2 IP address revealed**<br />
We finally get to a point where the C2 address and port are decoded and returned. In many cases in malware analysis, this is the key thing we are after especially if this is not revealing itself within a sandbox.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/13.png"/>

**HTTP Requests are performed**<br />
The request to the C2 server is finally made.  We can observe the URI and formData that it will submit. Throughout the running of this malware there are many requests to the same C2 performed as information is collected and exfiltrated.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/14.png"/>

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/15.png"/>

**Uploading browser data**<br />
As browser credentials and keys are collected there are calls made to submit them `/uploads`.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/16.png"/>

**Downloading pdown**
The `pdown` package is hosted on the C2 IP addresses and downloaded through a GET request to `C2_IP:1244/pdown`.  During my analysis this failed, and I had to pull this from VirusTotal. At the time of analysis, I did not catch how this was being used on the victim machine yet.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/17.png"/>

**InvisibleFerret script**<br />
A final request is made to download the `InvisibleFerret` malware script. This was also pulled down from VirusTotal once the C2 was discovered.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/18.png"/>

### Analyzing the InvisibleFerret loader script
The initial script is mostly `base64` encoded and performs some XOR decoding.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/19.png"/>

Expanding out and annotating what the python code is doing to the `base64` from above.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/20.png"/>

Using CyberChef to decode the script using the provided `XOR` key.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/21.png"/>

The key parts of the client script are shown below.

**Decoding the C2**<br />
This script will decode the C2 to be used later to download another payload script in the next step.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/22.png"/>

**Download the client payload script**<br />
If a `".n2"` directory is already in the users home directory it deletes it and recreates it.  It will then download another script from the C2 from the `"/payload/"` endpoint and save it to `"~/.n2/pay"`.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/23.png"/>

At this point it will execute the newly downloaded script.  The creation flags are setup to hide the window if on Windows.  The script will also exit at this point if the victim machine appears to be macOS.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/24.png"/>

**Download the brow script**<br />
Finally, if it is a Windows machine, it will additionally download a second script and save it to `"~/.n2/bow"` and execute it.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/25.png"/>

### Analyzing the InvisibleFerret payload script
We start out with an encoded script again that needs to go through a decoding process.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/26.png"/>

This is a little interesting as it generates a lambda that performs:
* reversing the bytes
* base64 decoding them
* zlib decompressing

The result ends up being another `exec((_)(b'XXX` as seen below.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/27.png"/>

This means that it is going to continue this process over and over until it reveals valid python code that will then be executed via the `exec()` function.  But how many iterations is this going to take?  To brute force this I wrote a little script to unpack it up to 255 iterations and tested for the text "import" as a success criteria.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/28.png"/>

[source: decode_invisibleferret_payload.py](https://github.com/tdmathison/revmal_scripts/blob/main/malware/invisible_ferret/decode_invisibleferret_payload.py)

It took 50 iterations to reveal valid python code of which we can now dump out and analyze. The resulting script is no longer obfuscated, and I studied the code and summarized what it does below.

#### What does the payload script do?
* Initial check-in with C2
  * Uses `ip-api.com` to get geo information on the victim IP
  * Collects uuid, system, release, version, hostname, and username from system
  * Connects to the C2 server and POST's this data to `"/keys"`
* Creates a thread to start a C2 communication loop with the adversary
  * Waits for commands from the C2
  * The incoming payloads are in JSON format
  * The payload will be a number that maps to a command class and arguments
  * Executes a keylogger and clipboard monitor

#### C2 Commands

<table>
<tr><td><b>Code</b></td><td><b>Command</b></td><td><b>Description</b></td></tr>
<tr><td>1</td><td>obj</td><td>Either executes a change directory (cd) command or executes an arbitrary command<br/> (depending on provided arguments).</td></tr>
<tr><td>2</td><td>cmd</td><td>If argument is <b>"delete"</b> the shell's session is forced to close.</td></tr>
<tr><td>3</td><td>clip</td><td>Sends back the current clipboard and keylogging buffer.</td></tr>
<tr><td>4</td><td>run</td><td>Tells client to download Browse script from <b>"C2_IP:PORT/brow/"</b>.</td></tr>
<tr><td>5</td><td>upload</td><td>Parses one of several commands.<br/><table><tr><td>sdira</td><td><b>FTP's all files from current directory and down</b> to the adversary-controlled server<br/> with address and credentials supplied in arguments.</td></tr><tr><td>sdir</td><td><b>FTP's the files of the current directory only</b> to the adversary-controlled server<br/> with address and credentials supplied in arguments.</td></tr><tr><td>sfile</td><td><b>FTP's a specific file.</b>  The contents of the file are XOR encoded with<br/> the key: <code>G01d*8@(</code></td></tr><tr><td>sfinda</td><td>Recursively searches for files matching a pattern starting from a directory provided<br/> in arguments.<br />* Uploads discovered files via <b>sfile</b> command (above)<br />* Excludes searching an exclusion list of directories</td></tr><tr><td>sfindr</td>
<td>Searches for files matching a pattern in the specified directory (non-recursive).<br />* Uploads discovered files via <b>sfile</b> command (above)<br />* Excludes searching an exclusion list of directories</td></tr><tr><td>sfind</td><td>Recursively searches for files matching a pattern starting at current directory.<br />* Uploads discovered files via <b>sfile</b> command (above)<br />* Excludes searching an exclusion list of directories</td></tr></table></td></tr>
<tr><td>6</td><td>kill</td><td>Kills all Chrome and Brave browser processes.</td></tr>
<tr><td>7</td><td>any</td><td>Tells client to download AnyDesk binary from <b>"C2_IP:PORT/adc/"</b>.</td></tr>
<tr><td>8</td><td>env</td><td>FTP's files related to user based on their home directory location.<br/><b>Windows</b><br/>* Copies files from <b>~\\Documents</b><br/>* Copies files from <b>~\\Downloads</b><br/><b>Non-Windows</b><br/>* Copies files from <b>/home</b><br/>* Copies files from <b>/Volumes</b></td></tr>
<tr><td>9</td><td>zcp</td><td><b>Multi-stage search and exfiltration</b><br />* Searches and copies all profile information and data related to many browser extensions<br/> for password managers, crypto, and authenticator (LastPass, Google authenticator, etc)<br/> extensions (searches by static list of browser extension IDs)<br />* Searches and copies all AppData files for 1pass, exodus, atomic, electrum, winauth,<br/> proxifier4, and dashlane<br />* Archives all files using a supplied password in argument or <b>"2024"</b> if not supplied<br />* Exfiltrates archive through Telegram</td></tr>
</table>

**Exfiltration through Telegram**<br/>
The adversary will send a token value as an argument to POST to a specific account.
<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/29.png"/>

#### Targeted browser extensions
The following table is a list of browser extensions that are searched for.

<table>
<tr style="font-family:courier new;font-size:small">
<td>
"aeachknmefphepccionboohckonoeemg": "Coin98"<br/>
"aholpfdialjgjfhomihkjbmgjidlcdno": "Exodus"<br/>
"bfnaelmomeimhlpmgjnjophhpkkoljpa": "Phantom"<br/>
"ejbalbakoplchlghecdalmeeeajnimhm": "MetaMask-Edge"<br/>
"ejjladinnckdgjemekebdpeokbikhfci": "PetraAptos"<br/>
"egjidjbpglichdcondbcbdnbeeppgdph": "Trust"<br/>
"fhbohimaelbohpjbbldcngcnapndodjp": "Binance"<br/>
"gjdfdfnbillbflbkmldbclkihgajchbg": "Termux"<br/>
"hifafgmccdpekplomjjkcfgodnhcellj": "Crypto.com"<br/>
"hnfanknocfeofbddgcijnmhnfnkdnaad": "CoinBase"<br/>
"ibnejdfjmmkpcnlpebklmnkoeoihofec": "TronLink"<br/>
"lgmpcpglpngdoalbgeoldeajfclnhafa": "Safepal"<br/>
"mcohilncbfahbmgdjkbpemcciiolgcge": "OKX"<br/>
"nkbihfbeogaeaoehlefnkodbefgpgknn": "MetaMask"<br/>
"nphplpgoakhhjchkkhmiggakijnkhfnd": "Ton"<br/>
"pdliaogehgdbhbnmkklieghmmjkpigpa": "ByBit"<br/>
"phkbamefinggmakgklpkljjmgibohnba": "Pontem"<br/>
"kkpllkodjeloidieedojogacfhpaihoh": "Enkrypt"<br/>
"agoakfejjabomempkjlepdflaleeobhb": "Core-Crypto"<br/>
"jiidiaalihmmhddjgbnbgdfflelocpak": "Bitget"<br/>
"kgdijkcfiglijhaglibaidbipiejjfdp": "Cirus"<br/>
"kkpehldckknjffeakihjajcjccmcjflh": "HBAR"<br/>
"idnnbdplmphpflfnlkomgpfbpcgelopg": "Xverse"<br/>
"fccgmnglbhajioalokbcidhcaikhlcpm": "Zapit"<br/>
"fijngjgcjhjmmpcmkeiomlglpeiijkld": "Talisman"<br/>
"enabgbdfcbaehmbigakijjabdpdnimlg": "Manta"<br/>
"onhogfjeacnfoofkfgppdlbmlmnplgbn": "Sub-Polkadot"<br/>
"amkmjjmmflddogmhpjloimipbofnfjih": "Wombat"<br/>
"glmhbknppefdmpemdmjnjlinpbclokhn": "Orange"<br/>
"hmeobnfnfcmdkdcmlblgagmfpfboieaf": "XDEFI"<br/>
"acmacodkjbdgmoleebolmdjonilkdbch": "Rabby"<br/>
"fcfcfllfndlomdhbehjjcoimbgofdncg": "LeapCosmos"<br/>
"anokgmphncpekkhclmingpimjmcooifb": "Compass-Sei"<br/>
"epapihdplajcdnnkdeiahlgigofloibg": "Sender"<br/>
"efbglgofoippbgcjepnhiblaibcnclgk": "Martian"<br/>
"ldinpeekobnhjjdofggfgjlcehhmanlj": "Leather"<br/>
"lccbohhgfkdikahanoclbdmaolidjdfl": "Wigwam"<br/>
"abkahkcbhngaebpcgfmhkoioedceoigp": "Casper"<br/>
"bhhhlbepdkbapadjdnnojkbgioiodbic": "Solflare"<br/>
"klghhnkeealcohjjanjjdaeeggmfmlpl": "Zerion"<br/>
"lnnnmfcpbkafcpgdilckhmhbkkbpkmid": "Koala"<br/>
"ibljocddagjghmlpgihahamcghfggcjc": "Virgo"<br/>
"ppbibelpcjmhbdihakflkdcoccbgbkpo": "UniSat"<br/>
"afbcbjpbpfadlkmhmclhkeeodmamcflc": "Math"<br/>
</td>
<td>
"ebfidpplhabeedpnhjnobghokpiioolj": "Fewcha-Move"<br/>
"fopmedgnkfpebgllppeddmmochcookhc": "Suku"<br/>
"gjagmgiddbbciopjhllkdnddhcglnemk": "Hashpack"<br/>
"jnlgamecbpmbajjfhmmmlhejkemejdma": "Braavos"<br/>
"pgiaagfkgcbnmiiolekcfmljdagdhlcm": "Stargazer"<br/>
"khpkpbbcccdmmclmpigdgddabeilkdpd": "Suiet"<br/>
"kilnpioakcdndlodeeceffgjdpojajlo": "Aurox"<br/>
"bopcbmipnjdcdfflfgjdgdjejmgpoaab": "Block"<br/>
"kmhcihpebfmpgmihbkipmjlmmioameka": "Eternl"<br/>
"aflkmfhebedbjioipglgcbcmnbpgliof": "Backpack"<br/>
"ajkifnllfhikkjbjopkhmjoieikeihjb": "Moso"<br/>
"pfccjkejcgoppjnllalolplgogenfojk": "Tomo"<br/>
"jaooiolkmfcmloonphpiiogkfckgciom": "Twetch"<br/>
"kmphdnilpmdejikjdnlbcnmnabepfgkh": "OsmWallet"<br/>
"hbbgbephgojikajhfbomhlmmollphcad": "Rise"<br/>
"nbdhibgjnjpnkajaghbffjbkcgljfgdi": "Ramper"<br/>
"fldfpgipfncgndfolcbkdeeknbbbnhcc": "MyTon"<br/>
"jnmbobjmhlngoefaiojfljckilhhlhcj": "OneKey"<br/>
"fcckkdbjnoikooededlapcalpionmalo": "MOBOX"<br/>
"gadbifgblmedliakbceidegloehmffic": "Paragon"<br/>
"ebaeifdbcjklcmoigppnpkcghndhpbbm": "SenSui"<br/>
"opfgelmcmbiajamepnmloijbpoleiama": "Rainbow"<br/>
"jfflgdhkeohhkelibbefdcgjijppkdeb": "OrdPay"<br/>
"kfecffoibanimcnjeajlcnbablfeafho": "Libonomy"<br/>
"opcgpfmipidbgpenhmajoajpbobppdil": "Sui"<br/>
"penjlddjkjgpnkllboccdgccekpkcbin": "OpenMask"<br/>
"kbdcddcmgoplfockflacnnefaehaiocb": "Shell"<br/>
"abogmiocnneedmmepnohnhlijcjpcifd": "Blade"<br/>
"omaabbefbmiijedngplfjmnooppbclkk": "Tonkeeper"<br/>
"cnncmdhjacpkmjmkcafchppbnpnhdmon": "HAVAH"<br/>
"eokbbaidfgdndnljmffldfgjklpjkdoi": "Fluent"<br/>
"fnjhmkhhmkbjkkabndcnnogagogbneec": "Ronin"<br/>
"dmkamcknogkgcdfhhbddcghachkejeap": "Keplr"<br/>
"dlcobpjiigpikoobohmabehhmhfoodbb": "ArgentX"<br/>
"aiifbnbfobpmeekipheeijimdpnlpgpp": "Station"<br/>
"eajafomhmkipbjmfmhebemolkcicgfmd": "Taho"<br/>
"mkpegjkblkkefacfnmkajcjmabijhclg": "MagicEden"<br/>
"ffbceckpkpbcmgiaehlloocglmijnpmp": "Initia"<br/>
"lpfcbjknijpeeillifnkikgncikgfhdo": "Nami"<br/>
"fpkhgmpbidmiogeglndfbkegfdlnajnf": "Cosmostation"<br/>
"kppfdiipphfccemcignhifpjkapfbihd": "Frontier"<br/>
"fdjamakpfbbddfjaooikfcpapjohcfmg": "Dashalane"<br/>
"bhghoamapcdpbohphigoooaddinpkbai": "GoogleAuth"<br/>
</td>
</tr>
</table>

### Analyzing the InvisibleFerret browser script
The browser script is in the same format as the initial client script appeared but uses a different XOR key to decode itself.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/30.png"/>

**What does the browser script do?**<br/>
* Retrieves the users `"Local State"` file to extract the key bytes
* For each browser
  * Opens the `"Login Data"` file
  * Decrypts all accounts and passwords
  * Opens the `"Web Data"` file
  * Decrypts all saved credit cards
* Exfiltrates this data back to the C2 IP by POST'ing it to `"/keys"`

**Example use-case for the Edge browser on Windows**
* Gets the `"Local State"` file to extract the decryption key
  * `%AppData%\Local\Microsoft\Edge\User Data\Local State`
* Gets the `"Login Data"` file to decrypt accounts and passwords
  * `C:\Users\Jack Simpson\AppData\Local\Microsoft\Edge\User Data\Default\Login Data`
* Gets the "Web Data" file to decrypt stored credit cards
  * `%AppData%\Local\Microsoft\Edge\User Data\Default\Web Data`

In a SqlLite3 browser we can execute the same query and see an example credential I added into the Edge browser.  We can see that the password value is a blob and encrypted hex.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/31.png"/>

We can see the query to fetch the stored credit cards as well and that the numbers are protected.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/32.png"/>

However, after reading what the malware is doing, I re-wrote the stealer code in a simplified version to demonstrate how this works against these database files on a Windows system.

We will first extract the decryption key out of the "Local State" file for the browser.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/33.png"/>
<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/34.png"/>

We will then decrypt the credentials from the `"Login Data"` file that contains the accounts and passwords.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/35.png"/>
<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/36.png"/>

We will then decrypt the credit card information from the `"Web Data"` file.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/37.png"/>
<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/38.png"/>

When this is printed out, we can see that we have properly decrypted the data.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/39.png"/>

This data is now exfiltrated back out to the adversary controlled C2 IP by POST'ing it to `"/keys"`.

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/40.png"/>

[source: ferret_browser_cred_theft.py](https://github.com/tdmathison/revmal_scripts/blob/main/malware/invisible_ferret/ferret_browser_cred_theft.py)

### Finding additional C2 IP addresses
Given the pattern identified in requests to the C2's I put together a query that should capture most of them based on In-The-Wild (ITW) URLs observed by VirusTotal. This was the primary way I collected additional C2 IP addresses for flow analysis.

```s
itw:":1224/keys" or itw:":1244/keys" or itw:":1224/pdown" or itw:":1244/pdown" or 
itw:":3000/pdown" or itw:":1224/payload" or itw:":1244/payload" or 
itw:":1244/uploads" or itw:":1224/uploads" or itw:":1224/brow/" or itw:":1244/brow/" 
or itw:":1244/client/" or itw:":1224/client/"
```

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/41.png"/>

### Censys Query
The websites on port `1224/tcp`, `1244/tcp`, `1245/tcp`, and `3000/tcp` seem to have some unique text in the html response that I tried querying for. Most of these results are in my list of C2 servers.  Two of them are not but look suspicious.

`services.http.response.html_title="Node.js upload multiple files"`

<img style="align:left" src="{{ site.url }}/assets/img/20240812_0/42.png"/>

### Snort signatures
There are two components that get downloaded upon infection by `InvisibleFerret` that we can detect on.  These show up as a GET requests to `/payload/X` and `/brow/X` as well as POST's to `/keys`.

```s
alert tcp $HOME_NET any -> $EXTERNAL_NET 1224,1244,1245 ( msg:"Trojan.InvisibleFerret/MC/FerretInfo Script Download"; flow:to_server; content:"GET /payload/"; offset:0; depth:13; pcre:"/GET |2f|payload|2f|[A-Za-z0-9\/]+ HTTP|2f|1\.1/"; content:"User-Agent: python-requests"; within:65; content:"Accept-Encoding: gzip, deflate|0d 0a|"; within:41; classtype:trojan-activity; priority:3; sid:824081200; rev:1; )
alert tcp $HOME_NET any -> $EXTERNAL_NET 1224,1244,1245 ( msg:"Trojan.InvisibleFerret/MC/FerretBrowse Script Download"; flow:to_server; content:"GET /brow/"; offset:0; depth:10; pcre:"/GET |2f|brow|2f|[A-Za-z0-9\/]+ HTTP|2f|1\.1/"; content:"User-Agent: python-requests"; within:61; content: "Accept-Encoding: gzip, deflate|0d 0a|"; within:41; classtype:trojan-activity; priority:3; sid:824081201; rev:1; )
alert tcp $HOME_NET any -> $EXTERNAL_NET 1224,1244,1245 ( msg:"Trojan.InvisibleFerret/MC/POST to keys (python)"; flow:to_server; content:"POST /keys HTTP/1.1|0d 0a|"; offset:0; depth:21; content:"User-Agent: python-requests"; within:55; content:"Content-Type: application/x-www-form-urlencoded|0d 0a 0d 0a|"; within:150; classtype:trojan-activity; priority:3; sid:824081202; rev:1; )
alert tcp $HOME_NET any -> $EXTERNAL_NET 1224,1244,1245 ( msg:"Trojan.InvisibleFerret/MC/POST to keys (non-python)"; flow:to_server; content:"POST /keys HTTP/1.1|0d 0a|"; offset:0; depth:21; content:"content-type: multipart|2f|form-data"; within: 61; content:"name=|22|ts|22|"; within:500; classtype:trojan-activity; priority:3; sid:824081203; rev:1; )
alert tcp $HOME_NET any -> $EXTERNAL_NET 1224,1244,1245 ( msg:"Trojan.InvisibleFerret/MC/POST to uploads"; flow:to_server; content:"POST /uploads HTTP/1.1|0d 0a|"; offset:0; depth:24; content:"content-type: multipart|2f|form-data"; within: 61; content:"name=|22|type|22|"; within:500; classtype:trojan-activity; priority:3; sid:824081204; rev:1; )
```

## Indicators of Compromise

| Name | Type | Value |
| ---- | ---- | ----- |
| malicious NodeJS (Beavertail) | MD5 | 7b75e49344843199f357a0e5d17eb5c1 |
| C2 | IPv4 | 23.106.253[.]194<br/>23.106.253[.]209<br/>45.61.131[.]218<br/>45.61.169[.]99<br/>67.203.7[.]163<br/>67.203.7[.]171<br/>95.164.17[.]24<br/>147.124.212[.]89<br/>147.124.212[.]146<br/>147.124.214[.]129<br/>147.124.214[.]131<br/>147.124.214[.]237<br/>167.88.168[.]152<br/>172.86.98[.]240<br/>185.235.241[.]208 |
| main_N3RFYU07.py (InvisibleFerret) | MD5 | 682d404dc90e389130f71bcb6b2ab7fb |
| pay_N3RFYU07.py (InvisibleFerret - payload) | MD5 | cb7a41eae4acd144505fc2d9b81ac2c5 |
| brow_N3RFYU07.py (InvisibleFerret - browse) | MD5 | 3686a3481b1c79f251dc3d4f428ac15e |

