<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="RC4 Crypto Usage in Malware" /><meta name="author" content="Travis Mathison" /><meta property="og:locale" content="en" /><meta name="description" content="Table of Contents" /><meta property="og:description" content="Table of Contents" /><link rel="canonical" href="https://tdmathison.github.io/posts/RC4-Crypto-Usage-In-Malware/" /><meta property="og:url" content="https://tdmathison.github.io/posts/RC4-Crypto-Usage-In-Malware/" /><meta property="og:site_name" content="Travis Mathison" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-08T01:16:00-07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="RC4 Crypto Usage in Malware" /><meta name="twitter:site" content="@ciph34block" /><meta name="twitter:creator" content="@Travis Mathison" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Travis Mathison"},"description":"Table of Contents","url":"https://tdmathison.github.io/posts/RC4-Crypto-Usage-In-Malware/","@type":"BlogPosting","headline":"RC4 Crypto Usage in Malware","dateModified":"2021-06-08T01:16:00-07:00","datePublished":"2021-06-08T01:16:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://tdmathison.github.io/posts/RC4-Crypto-Usage-In-Malware/"},"@context":"https://schema.org"}</script><title>RC4 Crypto Usage in Malware | Travis Mathison</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Travis Mathison"><meta name="application-name" content="Travis Mathison"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Travis Mathison</a></div><div class="site-subtitle font-italic">Malware Reverse Engineering and Threat Research.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/resources/" class="nav-link"> <i class="fa-fw fas fa-book ml-xl-3 mr-xl-3 unloaded"></i> <span>RESOURCES</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/tdmathison" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ciph34block" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/travismathison/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>RC4 Crypto Usage in Malware</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>RC4 Crypto Usage in Malware</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Travis Mathison </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Jun 8, 2021, 1:16 AM -0700" >Jun 8, 2021<i class="unloaded">2021-06-08T01:16:00-07:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="776 words">4 min read</span></div></div><div class="post-content"><p><strong>Table of Contents</strong></p><ul id="markdown-toc"><li><a href="#intro" id="markdown-toc-intro">Intro</a><li><a href="#the-malware-sample-used-in-this-blog-post" id="markdown-toc-the-malware-sample-used-in-this-blog-post">The malware sample used in this blog post</a><li><a href="#the-ksa-and-prga-functions" id="markdown-toc-the-ksa-and-prga-functions">The KSA and PRGA functions</a><li><a href="#observing-call-into-function" id="markdown-toc-observing-call-into-function">Observing call into function</a><li><a href="#key-scheduling-algorithm-ksa" id="markdown-toc-key-scheduling-algorithm-ksa">Key-scheduling algorithm (KSA)</a><ul><li><a href="#ksa-identity-permutation-initialization" id="markdown-toc-ksa-identity-permutation-initialization">KSA identity permutation (initialization)</a><li><a href="#ksa-loop-to-mix-in-key-bytes" id="markdown-toc-ksa-loop-to-mix-in-key-bytes">KSA loop to mix in key bytes</a></ul><li><a href="#pseudo-random-generation-algorithm-prga" id="markdown-toc-pseudo-random-generation-algorithm-prga">Pseudo-random generation algorithm (PRGA)</a><li><a href="#conclusion" id="markdown-toc-conclusion">Conclusion</a></ul><h2 id="intro">Intro</h2><p>During a deep dive analysis of a recent sample, another case of using RC4 came up and I thought it was a good example to show how it appeared in the malware. The RC4 encryption algorithm is encountered quite often in malware due to it’s ease of use and ability to hide strings and information and quickly change hashes in samples (sometimes changed dynamically per infection).</p><p>The well-known wiki page with pseudo-code is found here:<br /> <a href="https://en.wikipedia.org/wiki/RC4">https://en.wikipedia.org/wiki/RC4</a></p><p>From the pseudo-code on the wiki I translated it to python that can be used to test data and keys with:<br /> <a href="https://github.com/tdmathison/HelperScripts/blob/master/RC4/rc4.py">rc4.py</a></p><p>The goal is to be able to spot the use of it very quickly and due to its small KSA/PRGA looping algorithm it is typically easy to spot. Examples below show a specific case of this to help see it in a real-world sample.</p><h2 id="the-malware-sample-used-in-this-blog-post">The malware sample used in this blog post</h2><ul><li>MD5 hash: <code class="language-plaintext highlighter-rouge">8e3ecc68ad8bb0db61b5de65d8381eff</code><li>VirusTotal link to sample: <a href="https://www.virustotal.com/gui/file/20c8baddda18909c2cd6eb78ac904fe9ac1a1e96db37698b157b12f745ce1ff8/detection">https://www.virustotal.com/gui/file/20c8baddda18909c2cd6eb78ac904fe9ac1a1e96db37698b157b12f745ce1ff8/detection</a></ul><h2 id="the-ksa-and-prga-functions">The KSA and PRGA functions</h2><p>The Key-scheduling algorithm (KSA) and the Pseudo-random generation algorithm (PRGA) may be all in one call or split into two separate calls. In the case of this sample it is observed to be a single call.</p><p>The RC4 encryption can be thought of as two phases:<br /> 1) Generating the S-box array by initializing it with a key<br /> 2) Using the S-box array as a stream cipher to apply onto any data you want to encrypt or decrypt<br /></p><h2 id="observing-call-into-function">Observing call into function</h2><p>The key pieces of information that the RC4 algorithm will be looking for is the data, the length of the data, and the key that will be used when initializing the stream cipher. When debugging live, we can see from the call into the function a pointer to the <code class="language-plaintext highlighter-rouge">MZ</code> byte at the start of the data that will be encrypted in <code class="language-plaintext highlighter-rouge">ecx</code>, the length of this data in <code class="language-plaintext highlighter-rouge">edx</code>, and finally the key has been identified in <code class="language-plaintext highlighter-rouge">[esp]</code> with the bytes highlighted in the Dump 1 window.</p><p><img style="align:left" src="https://tdmathison.github.io/assets/img/blogging/rc4_01_call_with_key.png" /></p><h2 id="key-scheduling-algorithm-ksa">Key-scheduling algorithm (KSA)</h2><h3 id="ksa-identity-permutation-initialization">KSA identity permutation (initialization)</h3><p>Pseudo-code</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">for</span> <span class="n">i</span> <span class="n">from</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">255</span>
    <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:=</span> <span class="n">i</span>
<span class="n">endfor</span>
</pre></table></code></div></div><p>When looking for the presence of RC4 there are a few indicators to look for:<br /> 1) Loops for 256 iterations (look for compares of 100h or sometimes FFh)<br /> 2) An array being populated with the value of a counter (0, 1, 2, 3, …)<br /></p><p><img style="align:left" src="https://tdmathison.github.io/assets/img/blogging/rc4_02_ida_ksa_init_loop.png" /></p><p>When debugging live, we can see the buffer that was allocated with the series of bytes from <code class="language-plaintext highlighter-rouge">00</code> to <code class="language-plaintext highlighter-rouge">FF</code>. In this algorithm, the array of bytes is defined as “S” and is often referred to as the “s-box”.</p><p><img style="align:left" src="https://tdmathison.github.io/assets/img/blogging/rc4_03_ksa_init.png" /></p><h3 id="ksa-loop-to-mix-in-key-bytes">KSA loop to mix in key bytes</h3><p>Pseudo-code</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">j</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="n">from</span> <span class="mi">0</span> <span class="n">to</span> <span class="mi">255</span>
    <span class="n">j</span> <span class="o">:=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="n">mod</span> <span class="n">keylength</span><span class="p">])</span> <span class="n">mod</span> <span class="mi">256</span>
    <span class="n">swap</span> <span class="n">values</span> <span class="n">of</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="n">and</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
<span class="n">endfor</span>
</pre></table></code></div></div><p>You now want to look for a second loop across the same array that:<br /> 1) Loops for <code class="language-plaintext highlighter-rouge">100h</code> iterations like before<br /> 2) References bytes from the key<br /></p><p><img style="align:left" src="https://tdmathison.github.io/assets/img/blogging/rc4_04_ida_ksa_key_loop.png" /></p><p>The result of this second loop will scramble the s-box array to form the final array that will be used by the PRGA algorithm that will generate the bytes to <code class="language-plaintext highlighter-rouge">XOR</code> with the data to be encrypted or decrypted.</p><p><img style="align:left" src="https://tdmathison.github.io/assets/img/blogging/rc4_05_ksa_init_with_key.png" /></p><h2 id="pseudo-random-generation-algorithm-prga">Pseudo-random generation algorithm (PRGA)</h2><p>Pseudo-code</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">i</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="n">j</span> <span class="o">:=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="n">GeneratingOutput</span><span class="o">:</span>
    <span class="n">i</span> <span class="o">:=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="n">mod</span> <span class="mi">256</span>
    <span class="n">j</span> <span class="o">:=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="n">mod</span> <span class="mi">256</span>
    <span class="n">swap</span> <span class="n">values</span> <span class="n">of</span> <span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="n">and</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    <span class="n">K</span> <span class="o">:=</span> <span class="n">S</span><span class="p">[(</span><span class="n">S</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">S</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="n">mod</span> <span class="mi">256</span><span class="p">]</span>
    <span class="n">output</span> <span class="n">K</span>
<span class="n">endwhile</span>
</pre></table></code></div></div><p>The PRGA algorithm is where the magic happens and the bytes to <code class="language-plaintext highlighter-rouge">XOR</code> with your data bytes happen.</p><p>There are several indicators to look for when trying to identify this in the assembly:<br /> 1) This will be a third loop but will continue to the length of the data<br /> 2) The loop will be iterating over each byte in the data<br /> 3) At the very end of the loop you should see a <code class="language-plaintext highlighter-rouge">XOR</code> operation against the generated PRGA byte and a byte from the data<br /></p><p><img style="align:left" src="https://tdmathison.github.io/assets/img/blogging/rc4_06_ida_prga_loop.png" /></p><p>As this loop iterates you can watch the plaintext bytes in memory slowly encrypt.</p><p><img style="align:left" src="https://tdmathison.github.io/assets/img/blogging/rc4_07_prga_encrypting_data.png" /></p><h2 id="conclusion">Conclusion</h2><p>Since RC4 is used so heavily in malware it is important to be able to identify this quickly in static analysis reviews. Fortunately, due to the very distinct sequence of <code class="language-plaintext highlighter-rouge">100h</code> loops it is usually easy to identify and confirm.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blogging/'>Blogging</a>, <a href='/categories/malware-analysis/'>Malware-Analysis</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/rc4/" class="post-tag no-text-decoration" >rc4</a> <a href="/tags/crypto/" class="post-tag no-text-decoration" >crypto</a> <a href="/tags/ida/" class="post-tag no-text-decoration" >ida</a> <a href="/tags/debugging/" class="post-tag no-text-decoration" >debugging</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=RC4 Crypto Usage in Malware - Travis Mathison&url=https://tdmathison.github.io/posts/RC4-Crypto-Usage-In-Malware/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://tdmathison.github.io/posts/RC4-Crypto-Usage-In-Malware/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Hex-Rays-IDA-Tips-and-Tricks/">Hex-Rays IDA Tips and Tricks</a><li><a href="/posts/Npm_Coa_203_DanaBot_Dropper/">NPM COA@2.0.3 DanaBot Dropper</a><li><a href="/posts/MalwareReport-CTS/">Malware Report: CTS</a><li><a href="/posts/Resolving-IAT-with-AGDCservices-scripts/">Resolving IAT with AGDCservices Scripts</a><li><a href="/posts/Finding-the-start-of-Emotet-malware-in-MFC-app/">Finding the start of Emotet malware in MFC app</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/penetration-testing/">penetration-testing</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/exploit-development/">exploit-development</a> <a class="post-tag" href="/tags/ida/">ida</a> <a class="post-tag" href="/tags/shellcode/">shellcode</a> <a class="post-tag" href="/tags/slae32/">slae32</a> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/debugging/">debugging</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/MalwareReport-CTS/"><div class="card-body"> <span class="timeago small" >Jun 10, 2021<i class="unloaded">2021-06-10T15:42:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Malware Report: CTS</h3><div class="text-muted small"><p> Table of Contents Executive Summary Initial binary Infected binaries MITRE Attack Matrix Indicators of Compromise Threat intel insights Technical Anal...</p></div></div></a></div><div class="card"> <a href="/posts/Finding-the-start-of-Emotet-malware-in-MFC-app/"><div class="card-body"> <span class="timeago small" >Apr 7, 2021<i class="unloaded">2021-04-07T13:29:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Finding the start of Emotet malware in MFC app</h3><div class="text-muted small"><p> Intro Sometimes you need to dig a little to really find where the start of malicious code is in a binary. Sometimes it is not obvious from static analysis how exactly code flows to the malicious p...</p></div></div></a></div><div class="card"> <a href="/posts/Malware-decrypting-into-new-memory-maps/"><div class="card-body"> <span class="timeago small" >Apr 11, 2021<i class="unloaded">2021-04-11T14:29:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Malware decrypting into new memory maps</h3><div class="text-muted small"><p> Table of Contents Intro The malware sample used in this blog post Dealing with decoded bytes into new memory map Memory allocation and passing control Viewing new bytes in ID...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Resolving-IAT-with-AGDCservices-scripts/" class="btn btn-outline-primary" prompt="Older"><p>Resolving IAT with AGDCservices Scripts</p></a> <a href="/posts/MalwareReport-CTS/" class="btn btn-outline-primary" prompt="Newer"><p>Malware Report: CTS</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://tdmathison.github.io/posts/RC4-Crypto-Usage-In-Malware/'; this.page.identifier = '/posts/RC4-Crypto-Usage-In-Malware/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://tdmathison.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (modeToggle !== null) { modeToggle.addEventListener('click', reloadDisqus); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/ciph34block">Travis Mathison</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/penetration-testing/">penetration testing</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/exploit-development/">exploit development</a> <a class="post-tag" href="/tags/ida/">ida</a> <a class="post-tag" href="/tags/shellcode/">shellcode</a> <a class="post-tag" href="/tags/slae32/">slae32</a> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/debugging/">debugging</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-MXD056XG1T"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-MXD056XG1T'); }); </script>
