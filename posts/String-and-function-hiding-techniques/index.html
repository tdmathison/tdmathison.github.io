<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="String and function hiding techniques" /><meta name="author" content="Travis Mathison" /><meta property="og:locale" content="en" /><meta name="description" content="Table of Contents" /><meta property="og:description" content="Table of Contents" /><link rel="canonical" href="https://tdmathison.github.io/posts/String-and-function-hiding-techniques/" /><meta property="og:url" content="https://tdmathison.github.io/posts/String-and-function-hiding-techniques/" /><meta property="og:site_name" content="Travis Mathison" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-04-12T12:10:00-07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="String and function hiding techniques" /><meta name="twitter:site" content="@ciph34block" /><meta name="twitter:creator" content="@Travis Mathison" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Travis Mathison"},"description":"Table of Contents","url":"https://tdmathison.github.io/posts/String-and-function-hiding-techniques/","@type":"BlogPosting","headline":"String and function hiding techniques","dateModified":"2021-04-12T12:10:00-07:00","datePublished":"2021-04-12T12:10:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://tdmathison.github.io/posts/String-and-function-hiding-techniques/"},"@context":"https://schema.org"}</script><title>String and function hiding techniques | Travis Mathison</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Travis Mathison"><meta name="application-name" content="Travis Mathison"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Travis Mathison</a></div><div class="site-subtitle font-italic">Malware Reverse Engineering and Threat Research.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/resources/" class="nav-link"> <i class="fa-fw fas fa-book ml-xl-3 mr-xl-3 unloaded"></i> <span>RESOURCES</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/tdmathison" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ciph34block" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/travismathison/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>String and function hiding techniques</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>String and function hiding techniques</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Travis Mathison </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 12, 2021, 12:10 PM -0700" >Apr 12, 2021<i class="unloaded">2021-04-12T12:10:00-07:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2489 words">13 min read</span></div></div><div class="post-content"><p><strong>Table of Contents</strong></p><ul id="markdown-toc"><li><a href="#intro" id="markdown-toc-intro">Intro</a><li><a href="#the-malware-sample-used-in-this-blog-post" id="markdown-toc-the-malware-sample-used-in-this-blog-post">The malware sample used in this blog post</a><li><a href="#visual-of-observed-flows" id="markdown-toc-visual-of-observed-flows">Visual of observed flows</a><li><a href="#notable-techniques" id="markdown-toc-notable-techniques">Notable Techniques</a><ul><li><a href="#hiding-strings-via-single-byte-pushes-to-stack" id="markdown-toc-hiding-strings-via-single-byte-pushes-to-stack">Hiding strings via single byte pushes to stack</a><li><a href="#getting-dllbase-and-export-table" id="markdown-toc-getting-dllbase-and-export-table">Getting DllBase and export table</a><ul><li><a href="#thread-environment-block-teb" id="markdown-toc-thread-environment-block-teb">Thread Environment Block (TEB)</a><li><a href="#process-environment-block-peb" id="markdown-toc-process-environment-block-peb">Process Environment Block (PEB)</a><li><a href="#peb-loader-data" id="markdown-toc-peb-loader-data">PEB Loader Data</a><li><a href="#peb-loader-data-entry" id="markdown-toc-peb-loader-data-entry">PEB Loader Data Entry</a></ul><li><a href="#encoded-string-obfuscation" id="markdown-toc-encoded-string-obfuscation">Encoded string obfuscation</a></ul></ul><h2 id="intro">Intro</h2><p>This is carrying on from the previous post on finding the start of the malicious user code in the MFC application. While continuing to step through there are several notable techniques that are worth mentioning as they are common for a lot of malware.</p><p>Due to the size of this sample I won’t be continuing to analyze every assembly instruction and will use a more dynamic approach to attempt to locate the key areas big actions take place like copying itself to a new location and deleting it’s original file as well as performing a series of posts to a large collection of C&amp;C IPs.</p><p>This post will discuss three techniques seen early on:</p><ol><li>Hiding strings via single byte pushes to stack<li>Getting DllBase and export table to crawl export functions of ntdll.dll and kernel32.dll<li>Encoded string obfuscation</ol><h2 id="the-malware-sample-used-in-this-blog-post">The malware sample used in this blog post</h2><ul><li>MD5 hash: <code class="language-plaintext highlighter-rouge">a4513379dad5233afa402cc56a8b9222</code><li>VirusTotal link to sample: <a href="https://www.virustotal.com/gui/file/ccd380ea868ffad4f960d7455fecf88c2ac3550001bbb6c21c31ae70b3bbf4f6/detection">https://www.virustotal.com/gui/file/ccd380ea868ffad4f960d7455fecf88c2ac3550001bbb6c21c31ae70b3bbf4f6/detection</a></ul><h2 id="visual-of-observed-flows">Visual of observed flows</h2><p>An overall digram of the beginning flow that contains the techniques to be discussed.<br /> <img style="align:left" src="https://tdmathison.github.io/assets/img/blogging/tdc-phase2.png" /></p><p>Numbers techniques are tied to in the diagram:<br /> <img style="align:left" src="https://tdmathison.github.io/assets/img/blogging/tdc-phase2-notable-techniques.png" /></p><h2 id="notable-techniques">Notable Techniques</h2><h3 id="hiding-strings-via-single-byte-pushes-to-stack">Hiding strings via single byte pushes to stack</h3><p>Observe the following sequence of assembly. A repeating pattern of moving a single hex byte to <code class="language-plaintext highlighter-rouge">EAX</code> and pushing it to the stack is performed. NOTE: often it will be full <code class="language-plaintext highlighter-rouge">DWORD</code>’s that are pushed to put together a final string.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="mo">00500022</span>    <span class="n">B8</span> <span class="mi">6</span><span class="n">B000000</span>     <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="mi">6</span><span class="n">B</span>
<span class="mo">00500027</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8945</span> <span class="mi">98</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">68</span><span class="p">],</span><span class="n">AX</span>
<span class="mo">0050002</span><span class="n">B</span>    <span class="n">B9</span> <span class="mi">65000000</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="mi">65</span>
<span class="mo">00500030</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">894</span><span class="n">D</span> <span class="mi">9</span><span class="n">A</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">66</span><span class="p">],</span><span class="n">CX</span>
<span class="mo">00500034</span>    <span class="n">BA</span> <span class="mi">72000000</span>     <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="mi">72</span>
<span class="mo">0050003</span><span class="mi">9</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8955</span> <span class="mi">9</span><span class="n">C</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">64</span><span class="p">],</span><span class="n">DX</span>
<span class="mo">0050003</span><span class="n">D</span>    <span class="n">B8</span> <span class="mf">6E000000</span>     <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="mi">6</span><span class="n">E</span>
<span class="mo">00500042</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8945</span> <span class="mi">9</span><span class="n">E</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">62</span><span class="p">],</span><span class="n">AX</span>
<span class="mo">00500046</span>    <span class="n">B9</span> <span class="mi">65000000</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="mi">65</span>
<span class="mo">0050004</span><span class="n">B</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">894</span><span class="n">D</span> <span class="n">A0</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">60</span><span class="p">],</span><span class="n">CX</span>
<span class="mo">0050004</span><span class="n">F</span>    <span class="n">BA</span> <span class="mi">6</span><span class="n">C000000</span>     <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="mi">6</span><span class="n">C</span>
<span class="mo">00500054</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8955</span> <span class="n">A2</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">5</span><span class="n">E</span><span class="p">],</span><span class="n">DX</span>
<span class="mo">0050005</span><span class="mi">8</span>    <span class="n">B8</span> <span class="mi">33000000</span>     <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="mi">33</span>
<span class="mo">0050005</span><span class="n">D</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8945</span> <span class="n">A4</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">5</span><span class="n">C</span><span class="p">],</span><span class="n">AX</span>
<span class="mo">00500061</span>    <span class="n">B9</span> <span class="mi">32000000</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="mi">32</span>
<span class="mo">00500066</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">894</span><span class="n">D</span> <span class="n">A6</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">5</span><span class="n">A</span><span class="p">],</span><span class="n">CX</span>
<span class="mo">0050006</span><span class="n">A</span>    <span class="n">BA</span> <span class="mf">2E000000</span>     <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="mi">2</span><span class="n">E</span>
<span class="mo">0050006</span><span class="n">F</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8955</span> <span class="n">A8</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">58</span><span class="p">],</span><span class="n">DX</span>
<span class="mo">00500073</span>    <span class="n">B8</span> <span class="mi">64000000</span>     <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="mi">64</span>
<span class="mo">0050007</span><span class="mi">8</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8945</span> <span class="n">AA</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">56</span><span class="p">],</span><span class="n">AX</span>
<span class="mo">0050007</span><span class="n">C</span>    <span class="n">B9</span> <span class="mi">6</span><span class="n">C000000</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="mi">6</span><span class="n">C</span>
<span class="mo">005000</span><span class="mi">81</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">894</span><span class="n">D</span> <span class="n">AC</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">54</span><span class="p">],</span><span class="n">CX</span>
<span class="mo">005000</span><span class="mi">85</span>    <span class="n">BA</span> <span class="mi">6</span><span class="n">C000000</span>     <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="mi">6</span><span class="n">C</span>
<span class="mo">005000</span><span class="mi">8</span><span class="n">A</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8955</span> <span class="n">AE</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">52</span><span class="p">],</span><span class="n">DX</span>
<span class="mo">005000</span><span class="mi">8</span><span class="n">E</span>    <span class="mi">33</span><span class="n">C0</span>            <span class="n">XOR</span> <span class="n">EAX</span><span class="p">,</span><span class="n">EAX</span>
<span class="mo">005000</span><span class="mi">90</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8945</span> <span class="n">B0</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">50</span><span class="p">],</span><span class="n">AX</span>
<span class="mo">005000</span><span class="mi">94</span>    <span class="n">B9</span> <span class="mf">6E000000</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="mi">6</span><span class="n">E</span>
<span class="mo">005000</span><span class="mi">99</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">894</span><span class="n">D</span> <span class="n">B4</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">4</span><span class="n">C</span><span class="p">],</span><span class="n">CX</span>
<span class="mo">005000</span><span class="mi">9</span><span class="n">D</span>    <span class="n">BA</span> <span class="mi">74000000</span>     <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="mi">74</span>
<span class="mo">005000</span><span class="n">A2</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8955</span> <span class="n">B6</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">4</span><span class="n">A</span><span class="p">],</span><span class="n">DX</span>
<span class="mo">005000</span><span class="n">A6</span>    <span class="n">B8</span> <span class="mi">64000000</span>     <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="mi">64</span>
<span class="mo">005000</span><span class="n">AB</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8945</span> <span class="n">B8</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">48</span><span class="p">],</span><span class="n">AX</span>
<span class="mo">005000</span><span class="n">AF</span>    <span class="n">B9</span> <span class="mi">6</span><span class="n">C000000</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="mi">6</span><span class="n">C</span>
<span class="mo">005000</span><span class="n">B4</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">894</span><span class="n">D</span> <span class="n">BA</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">46</span><span class="p">],</span><span class="n">CX</span>
<span class="mo">005000</span><span class="n">B8</span>    <span class="n">BA</span> <span class="mi">6</span><span class="n">C000000</span>     <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="mi">6</span><span class="n">C</span>
<span class="mo">005000</span><span class="n">BD</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8955</span> <span class="n">BC</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">44</span><span class="p">],</span><span class="n">DX</span>
<span class="mo">005000</span><span class="n">C1</span>    <span class="n">B8</span> <span class="mf">2E000000</span>     <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="mi">2</span><span class="n">E</span>
<span class="mo">005000</span><span class="n">C6</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8945</span> <span class="n">BE</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">42</span><span class="p">],</span><span class="n">AX</span>
<span class="mo">005000</span><span class="n">CA</span>    <span class="n">B9</span> <span class="mi">64000000</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="mi">64</span>
<span class="mo">005000</span><span class="n">CF</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">894</span><span class="n">D</span> <span class="n">C0</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">40</span><span class="p">],</span><span class="n">CX</span>
<span class="mo">005000</span><span class="n">D3</span>    <span class="n">BA</span> <span class="mi">6</span><span class="n">C000000</span>     <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="mi">6</span><span class="n">C</span>
<span class="mo">005000</span><span class="n">D8</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8955</span> <span class="n">C2</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">3</span><span class="n">E</span><span class="p">],</span><span class="n">DX</span>
<span class="mo">005000</span><span class="n">DC</span>    <span class="n">B8</span> <span class="mi">6</span><span class="n">C000000</span>     <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="mi">6</span><span class="n">C</span>
<span class="mf">005000E1</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">8945</span> <span class="n">C4</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">3</span><span class="n">C</span><span class="p">],</span><span class="n">AX</span>
<span class="mf">005000E5</span>    <span class="mi">33</span><span class="n">C9</span>            <span class="n">XOR</span> <span class="n">ECX</span><span class="p">,</span><span class="n">ECX</span>
<span class="mf">005000E7</span>    <span class="mi">66</span><span class="o">:</span><span class="mi">894</span><span class="n">D</span> <span class="n">C6</span>      <span class="n">MOV</span> <span class="n">WORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">3</span><span class="n">A</span><span class="p">],</span><span class="n">CX</span>
<span class="mo">005000</span><span class="n">EB</span>    <span class="mi">8</span><span class="n">D55</span> <span class="n">B4</span>         <span class="n">LEA</span> <span class="n">EDX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">4</span><span class="n">C</span><span class="p">]</span>
<span class="mo">005000</span><span class="n">EE</span>    <span class="mi">52</span>              <span class="n">PUSH</span> <span class="n">EDX</span>
</pre></table></code></div></div><p>All these bytes pushed to the stack result in the string seen below (also note, when pushing to the stack it is being done in reverse order). The malware could have just had the full string saved in the <code class="language-plaintext highlighter-rouge">.data</code> section and loaded it, however, it would then come up in static analysis when searching for strings.</p><p>Many variations of this technique are used to hide DLL names or names of exported functions it will later fetch via <code class="language-plaintext highlighter-rouge">GetProcAddress</code> so they don’t show up in the export table during static analysis.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="mo">001</span><span class="mi">9</span><span class="n">F3EC</span>              <span class="mi">6</span><span class="n">B</span> <span class="mo">00</span> <span class="mi">65</span> <span class="mo">00</span> <span class="mi">72</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">E</span> <span class="mo">00</span> <span class="mi">65</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">C</span> <span class="mo">00</span>      <span class="n">k</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">n</span><span class="p">.</span><span class="n">e</span><span class="p">.</span><span class="n">l</span><span class="p">.</span>
<span class="mo">001</span><span class="mi">9</span><span class="n">F3FC</span>  <span class="mi">33</span> <span class="mo">00</span> <span class="mi">32</span> <span class="mo">00</span> <span class="mi">2</span><span class="n">E</span> <span class="mo">00</span> <span class="mi">64</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">C</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">C</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">19</span> <span class="mo">00</span>  <span class="mi">3</span><span class="p">.</span><span class="mi">2</span><span class="p">...</span><span class="n">d</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">l</span><span class="p">...</span><span class="err"></span><span class="p">.</span>
<span class="mo">001</span><span class="mi">9</span><span class="n">F40C</span>  <span class="mi">6</span><span class="n">E</span> <span class="mo">00</span> <span class="mi">74</span> <span class="mo">00</span> <span class="mi">64</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">C</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">C</span> <span class="mo">00</span> <span class="mi">2</span><span class="n">E</span> <span class="mo">00</span> <span class="mi">64</span> <span class="mo">00</span> <span class="mi">6</span><span class="n">C</span> <span class="mo">00</span>  <span class="n">n</span><span class="p">.</span><span class="n">t</span><span class="p">.</span><span class="n">d</span><span class="p">.</span><span class="n">l</span><span class="p">.</span><span class="n">l</span><span class="p">...</span><span class="n">d</span><span class="p">.</span><span class="n">l</span><span class="p">.</span>
<span class="mo">001</span><span class="mi">9</span><span class="n">F41C</span>  <span class="mi">6</span><span class="n">C</span> <span class="mo">00</span>                                            <span class="n">l</span><span class="p">.</span>
</pre></table></code></div></div><h3 id="getting-dllbase-and-export-table">Getting DllBase and export table</h3><p>Another sequence of calls that must be known has to do with getting the Process Environment Block (PEB), the LoaderData, the ModuleList, and the export table. Let’s take a look at two important structures and their offsets.</p><p>The Thread Environment Block (TEB) can be accessed via calls that look like <code class="language-plaintext highlighter-rouge">DWORD PTR FS:[30]</code>. In fact his is the most common one as its gets a reference to the PEB structure which is where the rest of the crawling around the structures typically start from.</p><p>The following structures and offsets are referenced in the following examples.</p><h4 id="thread-environment-block-teb">Thread Environment Block (TEB)</h4><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">TEB</span> <span class="p">{</span>
  <span class="n">DWORD</span>         <span class="n">EnvironmentPointer</span><span class="p">;</span>         <span class="c1">//+1C</span>
  <span class="n">DWORD</span>         <span class="n">ProcessId</span><span class="p">;</span>                  <span class="c1">//+20</span>
  <span class="n">DWORD</span>         <span class="n">threadId</span><span class="p">;</span>                   <span class="c1">//+24</span>
  <span class="n">DWORD</span>         <span class="n">ActiveRpcInfo</span><span class="p">;</span>              <span class="c1">//+28</span>
  <span class="n">DWORD</span>         <span class="n">ThreadLocalStoragePointer</span><span class="p">;</span>  <span class="c1">//+2C</span>
  <span class="n">PEB</span><span class="o">*</span>          <span class="n">Peb</span><span class="p">;</span>                        <span class="c1">//+30</span>
  <span class="p">...</span><span class="n">and</span> <span class="n">more</span><span class="p">...</span>
</pre></table></code></div></div><h4 id="process-environment-block-peb">Process Environment Block (PEB)</h4><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">PEB</span> <span class="p">{</span>
  <span class="kt">char</span>           <span class="n">InheritedAddressSpace</span><span class="p">;</span>    <span class="c1">//+00</span>
  <span class="kt">char</span>           <span class="n">ReadImageFileExecOptions</span><span class="p">;</span> <span class="c1">//+01</span>
  <span class="kt">char</span>           <span class="n">BeingDebugged</span><span class="p">;</span>            <span class="c1">//+02</span>
  <span class="kt">char</span>           <span class="n">Spare</span><span class="p">;</span>                    <span class="c1">//+03</span>
  <span class="n">DWORD</span>          <span class="n">Mutant</span><span class="p">;</span>                   <span class="c1">//+04</span>
  <span class="n">DWORD</span>          <span class="n">ImageBaseAddress</span><span class="p">;</span>         <span class="c1">//+08</span>
  <span class="n">_PEB_LDR_DATA</span><span class="o">*</span> <span class="n">LoaderData</span><span class="p">;</span>               <span class="c1">//+0C</span>
  <span class="p">...</span><span class="n">and</span> <span class="n">more</span><span class="p">...</span>
</pre></table></code></div></div><h4 id="peb-loader-data">PEB Loader Data</h4><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">_PEB_LDR_DATA</span> <span class="p">{</span>
    <span class="n">DWORD</span>        <span class="n">Length_</span><span class="p">;</span>                         <span class="c1">//+00</span>
    <span class="n">DWORD</span>        <span class="n">Initialized</span><span class="p">;</span>                     <span class="c1">//+04</span>
    <span class="n">DWORD</span>        <span class="n">SsHandle</span><span class="p">;</span>                        <span class="c1">//+08</span>
    <span class="n">__LIST_ENTRY</span> <span class="n">InLoadOrderModuleList</span><span class="p">;</span>           <span class="c1">//+0C</span>
    <span class="n">__LIST_ENTRY</span> <span class="n">InMemoryOrderModuleList</span><span class="p">;</span>         <span class="c1">//+14</span>
    <span class="n">__LIST_ENTRY</span> <span class="n">InInitializationOrderModuleList</span><span class="p">;</span> <span class="c1">//+1C</span>
    <span class="n">DWORD</span>        <span class="n">EntryInProgress</span><span class="p">;</span>                 <span class="c1">//+24  </span>
    <span class="n">DWORD</span>        <span class="n">ShutdownInProgress</span><span class="p">;</span>              <span class="c1">//+28</span>
    <span class="n">DWORD</span>        <span class="n">ShutdownThreadId</span><span class="p">;</span>                <span class="c1">//+2C</span>
<span class="p">};</span>
</pre></table></code></div></div><h4 id="peb-loader-data-entry">PEB Loader Data Entry</h4><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">_LDR_DATA_TABLE_ENTRY</span><span class="p">{</span>
  <span class="n">__LIST_ENTRY</span> <span class="n">InLoadOrderLinks</span><span class="p">;</span>               <span class="c1">//+00</span>
  <span class="n">__LIST_ENTRY</span> <span class="n">InMemoryOrderLinks</span><span class="p">;</span>             <span class="c1">//+08</span>
  <span class="n">__LIST_ENTRY</span> <span class="n">InInitializationOrderLinks</span><span class="p">;</span>     <span class="c1">//+10</span>
  <span class="n">DWORD</span>        <span class="n">DllBase</span><span class="p">;</span>                        <span class="c1">//+18</span>
  <span class="n">DWORD</span>        <span class="n">EntryPoint</span><span class="p">;</span>                     <span class="c1">//+1C</span>
  <span class="n">DWORD</span>        <span class="n">SizeOfImage</span><span class="p">;</span>                    <span class="c1">//+20</span>
  <span class="n">DWORD</span>        <span class="n">FullDllNameLength</span><span class="p">;</span>              <span class="c1">//+24</span>
  <span class="kt">char</span><span class="o">*</span>        <span class="n">FullDllName</span><span class="p">;</span> <span class="c1">// _UNICODE_STRING //+28</span>
  <span class="n">DWORD</span>        <span class="n">BaseDllNameLength</span><span class="p">;</span>              <span class="c1">//+2C</span>
  <span class="kt">char</span><span class="o">*</span>        <span class="n">BaseDllName</span><span class="p">;</span> <span class="c1">//_UNICODE_STRING  //+30</span>
  <span class="n">DWORD</span>        <span class="n">Flags</span><span class="p">;</span>                          <span class="c1">//+34</span>
  <span class="kt">short</span>        <span class="n">LoadCount</span><span class="p">;</span>                      <span class="c1">//+38</span>
  <span class="kt">short</span>        <span class="n">TlsIndex</span><span class="p">;</span>                       <span class="c1">//+3C</span>
  <span class="p">...</span><span class="n">and</span> <span class="n">more</span><span class="p">...</span>
<span class="p">};</span>
</pre></table></code></div></div><p>In our sample, we have the following function. It attempts to get the base address of <code class="language-plaintext highlighter-rouge">ntdll.dll</code> through the following sequence of structure crawling:<br /> <img style="align:left" src="https://tdmathison.github.io/assets/img/blogging/tdc-phase2-get-dllbase.png" /></p><p>The below assembly can be summed up as “find ntdll.dll and return the base address of it”.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="mo">00500260</span>    <span class="mi">55</span>              <span class="n">PUSH</span> <span class="n">EBP</span>
<span class="mo">00500261</span>    <span class="mi">8</span><span class="n">BEC</span>            <span class="n">MOV</span> <span class="n">EBP</span><span class="p">,</span><span class="n">ESP</span>
<span class="mo">00500263</span>    <span class="mi">83</span><span class="n">EC</span> <span class="mi">10</span>         <span class="n">SUB</span> <span class="n">ESP</span><span class="p">,</span><span class="mi">10</span>
<span class="mo">00500266</span>    <span class="mi">64</span><span class="o">:</span><span class="n">A1</span> <span class="mi">30000000</span>  <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">FS</span><span class="o">:</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span>     <span class="p">;</span> <span class="n">PEB</span>
<span class="mo">0050026</span><span class="n">C</span>    <span class="mi">8945</span> <span class="n">F4</span>         <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="n">C</span><span class="p">],</span><span class="n">EAX</span>
<span class="mo">0050026</span><span class="n">F</span>    <span class="mi">8</span><span class="n">B4D</span> <span class="n">F4</span>         <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="n">C</span><span class="p">]</span>
<span class="mo">00500272</span>    <span class="mi">8</span><span class="n">B51</span> <span class="mi">0</span><span class="n">C</span>         <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="n">C</span><span class="p">]</span>  <span class="p">;</span> <span class="n">_PEB_LDR_DATA</span><span class="o">*</span> <span class="n">LoaderData</span>
<span class="mo">00500275</span>    <span class="mi">8955</span> <span class="n">F8</span>         <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">8</span><span class="p">],</span><span class="n">EDX</span>
<span class="mo">0050027</span><span class="mi">8</span>    <span class="mi">8</span><span class="n">B45</span> <span class="n">F8</span>         <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
<span class="mo">0050027</span><span class="n">B</span>    <span class="mi">8</span><span class="n">B48</span> <span class="mi">0</span><span class="n">C</span>         <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">EAX</span><span class="o">+</span><span class="n">C</span><span class="p">]</span>  <span class="p">;</span> <span class="n">__LIST_ENTRY</span> <span class="n">InLoadOrderModuleList</span>
<span class="mo">0050027</span><span class="n">E</span>    <span class="mi">894</span><span class="n">D</span> <span class="n">F0</span>         <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">ECX</span>
<span class="mo">005002</span><span class="mi">81</span>    <span class="mi">8</span><span class="n">B55</span> <span class="n">F8</span>         <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
<span class="mo">005002</span><span class="mi">84</span>    <span class="mi">8</span><span class="n">B42</span> <span class="mi">0</span><span class="n">C</span>         <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="n">C</span><span class="p">]</span>
<span class="mo">005002</span><span class="mi">87</span>    <span class="mi">8945</span> <span class="n">FC</span>         <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span><span class="n">EAX</span>
<span class="mo">005002</span><span class="mi">8</span><span class="n">A</span>    <span class="mi">8</span><span class="n">B4D</span> <span class="mi">08</span>         <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
<span class="mo">005002</span><span class="mi">8</span><span class="n">D</span>    <span class="mi">51</span>              <span class="n">PUSH</span> <span class="n">ECX</span>
<span class="mo">005002</span><span class="mi">8</span><span class="n">E</span>    <span class="mi">8</span><span class="n">B55</span> <span class="n">FC</span>         <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
<span class="mo">005002</span><span class="mi">91</span>    <span class="mi">8</span><span class="n">B42</span> <span class="mi">30</span>         <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="mi">30</span><span class="p">]</span> <span class="p">;</span> <span class="n">name</span> <span class="n">of</span> <span class="n">running</span> <span class="n">binary</span>
<span class="mo">005002</span><span class="mi">94</span>    <span class="mi">50</span>              <span class="n">PUSH</span> <span class="n">EAX</span>
<span class="mo">005002</span><span class="mi">95</span>    <span class="n">E8</span> <span class="mi">66000000</span>     <span class="n">CALL</span> <span class="mo">00500300</span>                 <span class="p">;</span> <span class="n">compare_strings</span>
<span class="mo">005002</span><span class="mi">9</span><span class="n">A</span>    <span class="mi">83</span><span class="n">C4</span> <span class="mi">08</span>         <span class="n">ADD</span> <span class="n">ESP</span><span class="p">,</span><span class="mi">8</span>
<span class="mo">005002</span><span class="mi">9</span><span class="n">D</span>    <span class="mi">85</span><span class="n">C0</span>            <span class="n">TEST</span> <span class="n">EAX</span><span class="p">,</span><span class="n">EAX</span>
<span class="mo">005002</span><span class="mi">9</span><span class="n">F</span>    <span class="mi">75</span> <span class="mi">08</span>           <span class="n">JNZ</span> <span class="n">SHORT</span> <span class="mo">005002</span><span class="n">A9</span>            <span class="p">;</span> <span class="k">do</span> <span class="n">not</span> <span class="n">match</span>
<span class="mo">005002</span><span class="n">A1</span>    <span class="mi">8</span><span class="n">B4D</span> <span class="n">FC</span>         <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>  <span class="p">;</span> <span class="n">ECX</span> <span class="o">=</span> <span class="n">_LDR_DATA_TABLE_ENTRY</span>
<span class="mo">005002</span><span class="n">A4</span>    <span class="mi">8</span><span class="n">B41</span> <span class="mi">18</span>         <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mi">18</span><span class="p">]</span> <span class="p">;</span> <span class="n">EAX</span> <span class="o">=</span> <span class="n">DWORD</span> <span class="n">DllBase</span>
<span class="mo">005002</span><span class="n">A7</span>    <span class="n">EB</span> <span class="mi">12</span>           <span class="n">JMP</span> <span class="n">SHORT</span> <span class="mo">005002</span><span class="n">BB</span>            <span class="p">;</span> <span class="n">found</span> <span class="n">match</span> <span class="o">-&gt;</span> <span class="n">exit</span> <span class="n">loop</span>
<span class="mo">005002</span><span class="n">A9</span>    <span class="mi">8</span><span class="n">B55</span> <span class="n">FC</span>         <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
<span class="mo">005002</span><span class="n">AC</span>    <span class="mi">8</span><span class="n">B02</span>            <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">EDX</span><span class="p">]</span>
<span class="mo">005002</span><span class="n">AE</span>    <span class="mi">8945</span> <span class="n">FC</span>         <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span><span class="n">EAX</span>
<span class="mo">005002</span><span class="n">B1</span>    <span class="mi">8</span><span class="n">B4D</span> <span class="n">FC</span>         <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
<span class="mo">005002</span><span class="n">B4</span>    <span class="mi">3</span><span class="n">B4D</span> <span class="n">F0</span>         <span class="n">CMP</span> <span class="n">ECX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span>
<span class="mo">005002</span><span class="n">B7</span>  <span class="o">^</span> <span class="mi">75</span> <span class="n">D1</span>           <span class="n">JNZ</span> <span class="n">SHORT</span> <span class="mo">005002</span><span class="mi">8</span><span class="n">A</span>
<span class="mo">005002</span><span class="n">B9</span>    <span class="mi">33</span><span class="n">C0</span>            <span class="n">XOR</span> <span class="n">EAX</span><span class="p">,</span><span class="n">EAX</span>
<span class="mo">005002</span><span class="n">BB</span>    <span class="mi">8</span><span class="n">BE5</span>            <span class="n">MOV</span> <span class="n">ESP</span><span class="p">,</span><span class="n">EBP</span>
<span class="mo">005002</span><span class="n">BD</span>    <span class="mi">5</span><span class="n">D</span>              <span class="n">POP</span> <span class="n">EBP</span>
<span class="mo">005002</span><span class="n">BE</span>    <span class="n">C3</span>              <span class="n">RETN</span>
</pre></table></code></div></div><p>Now that we have the <code class="language-plaintext highlighter-rouge">DllBase</code> of <code class="language-plaintext highlighter-rouge">ntdll.dll</code> we can go a step further and get to the EXPORT table to enumerate it’s exported functions (this same process can be done for any DLL, not just for <code class="language-plaintext highlighter-rouge">ntdll.dll</code>).</p><p>The following structure is the target of the next action this malware performs which is to get the exported names, addresses, and ordinals.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">struct</span> <span class="n">image_export_directory</span>
<span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">characteristics</span><span class="p">;</span>          <span class="c1">//+00</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="p">;</span>                <span class="c1">//+04</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">major_version</span><span class="p">;</span>           <span class="c1">//+08</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">minor_version</span><span class="p">;</span>           <span class="c1">//+0A</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">name</span><span class="p">;</span>                     <span class="c1">//+0C</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>                     <span class="c1">//+10</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">number_of_functions</span><span class="p">;</span>      <span class="c1">//+14</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">number_of_names</span><span class="p">;</span>          <span class="c1">//+18</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address_of_functions</span><span class="p">;</span>     <span class="c1">//+1C // RVA from base of image</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address_of_names</span><span class="p">;</span>         <span class="c1">//+20 // RVA from base of image</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">address_of_name_ordinals</span><span class="p">;</span> <span class="c1">//+24 // RVA from base of image</span>
<span class="p">};</span>
</pre></table></code></div></div><p>The below function has access to the <code class="language-plaintext highlighter-rouge">BaseDll</code> address which is stored in <code class="language-plaintext highlighter-rouge">EBP+8</code>.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="mo">00500540</span>    <span class="mi">55</span>              <span class="n">PUSH</span> <span class="n">EBP</span>
<span class="mo">00500541</span>    <span class="mi">8</span><span class="n">BEC</span>            <span class="n">MOV</span> <span class="n">EBP</span><span class="p">,</span><span class="n">ESP</span>
<span class="mo">00500543</span>    <span class="mi">83</span><span class="n">EC</span> <span class="mi">20</span>         <span class="n">SUB</span> <span class="n">ESP</span><span class="p">,</span><span class="mi">20</span>
<span class="mo">00500546</span>    <span class="mi">8</span><span class="n">B45</span> <span class="mi">08</span>         <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>   <span class="p">;</span> <span class="n">EAX</span> <span class="o">=</span> <span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">-&gt;</span><span class="n">BaseDll</span>
<span class="mo">0050054</span><span class="mi">9</span>    <span class="mi">8945</span> <span class="n">F4</span>         <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="n">C</span><span class="p">],</span><span class="n">EAX</span>
<span class="mo">0050054</span><span class="n">C</span>    <span class="mi">8</span><span class="n">B4D</span> <span class="n">F4</span>         <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="n">C</span><span class="p">]</span>
<span class="mo">0050054</span><span class="n">F</span>    <span class="mi">8</span><span class="n">B55</span> <span class="mi">08</span>         <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
<span class="mo">00500552</span>    <span class="mo">0351</span> <span class="mi">3</span><span class="n">C</span>         <span class="n">ADD</span> <span class="n">EDX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mi">3</span><span class="n">C</span><span class="p">]</span>  <span class="p">;</span> <span class="n">PE</span> <span class="n">offset</span> <span class="p">(</span><span class="n">skip</span> <span class="n">DOS</span> <span class="n">header</span><span class="p">)</span>
<span class="mo">00500555</span>    <span class="mi">8955</span> <span class="n">F0</span>         <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">10</span><span class="p">],</span><span class="n">EDX</span>
<span class="mo">00500560</span>    <span class="mi">8</span><span class="n">B55</span> <span class="n">F0</span>         <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span>     <span class="p">;</span> <span class="n">PE</span> <span class="n">offset</span>
<span class="mo">00500563</span>    <span class="mi">8</span><span class="n">B45</span> <span class="mi">08</span>         <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>      <span class="p">;</span> <span class="n">ntdll</span><span class="p">.</span><span class="n">dll</span><span class="o">-&gt;</span><span class="n">BaseDll</span>
<span class="mo">00500566</span>    <span class="mo">03440</span><span class="n">A</span> <span class="mi">78</span>       <span class="n">ADD</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="n">ECX</span><span class="o">+</span><span class="mi">78</span><span class="p">]</span> <span class="p">;</span> <span class="n">EXPORT</span> <span class="n">table</span> <span class="n">data</span> <span class="n">entry</span>

<span class="mo">0050056</span><span class="n">A</span>    <span class="mi">8945</span> <span class="n">F8</span>         <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">8</span><span class="p">],</span><span class="n">EAX</span>
<span class="mo">0050056</span><span class="n">D</span>    <span class="mi">8</span><span class="n">B4D</span> <span class="n">F8</span>         <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
<span class="mo">00500570</span>    <span class="mi">8</span><span class="n">B55</span> <span class="mi">08</span>         <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>

<span class="p">;</span> <span class="n">RVA</span> <span class="n">of</span> <span class="n">Name</span> <span class="n">Pointer</span> <span class="n">Table</span> <span class="o">-</span> <span class="n">addresses</span> <span class="n">of</span> <span class="n">exported</span> <span class="n">function</span> <span class="n">names</span>
<span class="mo">00500573</span>    <span class="mo">0351</span> <span class="mi">20</span>         <span class="n">ADD</span> <span class="n">EDX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">ECX</span><span class="o">+</span><span class="mi">20</span><span class="p">]</span>                 
<span class="mo">00500576</span>    <span class="mi">8955</span> <span class="n">EC</span>         <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">14</span><span class="p">],</span><span class="n">EDX</span>
<span class="mo">0050057</span><span class="mi">9</span>    <span class="mi">8</span><span class="n">B45</span> <span class="n">F8</span>         <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
<span class="mo">0050057</span><span class="n">C</span>    <span class="mi">8</span><span class="n">B4D</span> <span class="mi">08</span>         <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>

<span class="p">;</span> <span class="n">RVA</span> <span class="n">of</span> <span class="n">Address</span> <span class="n">Table</span> <span class="o">-</span> <span class="n">addresses</span> <span class="n">of</span> <span class="n">exported</span> <span class="n">functions</span>
<span class="mo">0050057</span><span class="n">F</span>    <span class="mo">034</span><span class="mi">8</span> <span class="mi">1</span><span class="n">C</span>         <span class="n">ADD</span> <span class="n">ECX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">EAX</span><span class="o">+</span><span class="mi">1</span><span class="n">C</span><span class="p">]</span>
<span class="mo">005005</span><span class="mi">82</span>    <span class="mi">894</span><span class="n">D</span> <span class="n">E0</span>         <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">20</span><span class="p">],</span><span class="n">ECX</span>
<span class="mo">005005</span><span class="mi">85</span>    <span class="mi">8</span><span class="n">B55</span> <span class="n">F8</span>         <span class="n">MOV</span> <span class="n">EDX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
<span class="mo">005005</span><span class="mi">88</span>    <span class="mi">8</span><span class="n">B45</span> <span class="mi">08</span>         <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>

<span class="p">;</span> <span class="n">RVA</span> <span class="n">of</span> <span class="n">Ordinal</span> <span class="n">Table</span> <span class="o">-</span> <span class="n">function</span> <span class="n">order</span> <span class="n">number</span> <span class="n">as</span> <span class="n">listed</span> <span class="n">in</span> <span class="n">the</span> <span class="n">table</span>
<span class="mo">005005</span><span class="mi">8</span><span class="n">B</span>    <span class="mo">0342</span> <span class="mi">24</span>         <span class="n">ADD</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="mi">24</span><span class="p">]</span>
</pre></table></code></div></div><p>When studying the <a href="https://docs.microsoft.com/en-us/windows/win32/debug/pe-format">PE-Format</a> we can see that Win32 binaries have a DOS Stub that is placed at the front of the EXE image. The format states that:</p><blockquote><p>“At location 0x3c, the stub has the file offset to the PE signature. This information enables Windows to properly execute the image file, even though it has an MS-DOS stub. This file offset is placed at location 0x3c during linking.”</p></blockquote><p>With this known, we can view a table of offsets relative to <code class="language-plaintext highlighter-rouge">DllBase+3C</code> to make sense of which structures or addresses the malware is after in the above sample.<br /></p><div class="table-wrapper"><table><thead><tr><th style="text-align: left">Structure / Address<th style="text-align: left">Offset<tbody><tr><td style="text-align: left">RVA of Export Table<td style="text-align: left">0x78<tr><td style="text-align: left">address_of_functions<td style="text-align: left">0x78+0x1C<tr><td style="text-align: left">address_of_names<td style="text-align: left">0x78+0x20<tr><td style="text-align: left">address_of_name_ordinals<td style="text-align: left">0x78+0x24</table></div><p>Now, with <code class="language-plaintext highlighter-rouge">EBP-14</code> containing the addresses of exported function names we see it iterate over it via a counter in <code class="language-plaintext highlighter-rouge">ECX</code> and index to each subsequent item which are all 4 bytes long.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">;</span> <span class="n">ECX</span> <span class="o">=</span> <span class="n">counter</span>
<span class="mo">005005</span><span class="n">AE</span>    <span class="mi">8</span><span class="n">B4D</span> <span class="n">FC</span>         <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">EBP</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
<span class="p">...</span>
<span class="p">;</span> <span class="n">index</span> <span class="n">into</span> <span class="n">next</span> <span class="n">exported</span> <span class="n">function</span> <span class="n">name</span>
<span class="mo">005005</span><span class="n">B7</span>    <span class="mo">0304</span><span class="mi">8</span><span class="n">A</span>          <span class="n">ADD</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">EDX</span><span class="o">+</span><span class="n">ECX</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span>
</pre></table></code></div></div><p>In this sample we are analyzing it is looping through searching for specific exported function names that are encoded in some way. As it will turn out, the method in which is encodes them doesn’t really matter but it does show another example of how the names would not turn up during the initial static analysis.</p><h3 id="encoded-string-obfuscation">Encoded string obfuscation</h3><p>This sample decrypted a resource file found as RCData = 666 (0x29A). You can see this if you view the original binary in Resource Hacker. It is mapped to <code class="language-plaintext highlighter-rouge">00560000</code> and called into via the following instruction:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="mo">00560024</span>    <span class="n">E8</span> <span class="mo">04000000</span>     <span class="n">CALL</span> <span class="mo">0056002</span><span class="n">D</span>
</pre></table></code></div></div><p>In the following instructions we see a case where the name of the exported function was encoded in some way and stored. Upon looping through the exported function names via the previous technique it will use the same encoding function to generate a comparable string to perform a match on.</p><p>You can think of this similar to how passwords are hashed and the hash is stored. Upon typing a password in it re-hashes it in the same way and then compares them. This is essentially what we see here and the exact method of encoding becomes less important once it was understood exactly what the <code class="language-plaintext highlighter-rouge">00560467</code> function was doing.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="mo">0056002</span><span class="n">D</span>    <span class="mi">83</span><span class="n">EC</span> <span class="mi">48</span>         <span class="n">SUB</span> <span class="n">ESP</span><span class="p">,</span><span class="mi">48</span>
<span class="mo">00560030</span>    <span class="mi">836424</span> <span class="mi">18</span> <span class="mo">00</span>    <span class="n">AND</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">ESP</span><span class="o">+</span><span class="mi">18</span><span class="p">],</span><span class="mi">0</span>
<span class="mo">00560035</span>    <span class="n">B9</span> <span class="mi">4</span><span class="n">C772607</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="mi">726774</span><span class="n">C</span>
<span class="mo">0056003</span><span class="n">A</span>    <span class="mi">53</span>              <span class="n">PUSH</span> <span class="n">EBX</span>
<span class="mo">0056003</span><span class="n">B</span>    <span class="mi">55</span>              <span class="n">PUSH</span> <span class="n">EBP</span>
<span class="mo">0056003</span><span class="n">C</span>    <span class="mi">56</span>              <span class="n">PUSH</span> <span class="n">ESI</span>
<span class="mo">0056003</span><span class="n">D</span>    <span class="mi">57</span>              <span class="n">PUSH</span> <span class="n">EDI</span>
<span class="mo">0056003</span><span class="n">E</span>    <span class="mi">33</span><span class="n">F6</span>            <span class="n">XOR</span> <span class="n">ESI</span><span class="p">,</span><span class="n">ESI</span>
<span class="mo">00560040</span>    <span class="n">E8</span> <span class="mi">22040000</span>     <span class="n">CALL</span> <span class="mo">00560467</span> <span class="p">;</span> <span class="mi">726774</span><span class="n">C</span> <span class="o">=</span> <span class="n">KERNEL32</span><span class="p">.</span><span class="n">LoadLibraryA</span>
<span class="mo">00560045</span>    <span class="n">B9</span> <span class="mi">49</span><span class="n">F70278</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="mi">7802</span><span class="n">F749</span>
<span class="mo">0056004</span><span class="n">A</span>    <span class="mi">894424</span> <span class="mi">1</span><span class="n">C</span>       <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">ESP</span><span class="o">+</span><span class="mi">1</span><span class="n">C</span><span class="p">],</span><span class="n">EAX</span>
<span class="mo">0056004</span><span class="n">E</span>    <span class="n">E8</span> <span class="mi">14040000</span>     <span class="n">CALL</span> <span class="mo">00560467</span> <span class="p">;</span> <span class="mi">7802</span><span class="n">F749</span> <span class="o">=</span> <span class="n">KERNEL32</span><span class="p">.</span><span class="n">GetProcAddress</span>
<span class="mo">00560053</span>    <span class="n">B9</span> <span class="mi">58</span><span class="n">A453E5</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="n">E553A458</span>
<span class="mo">0056005</span><span class="mi">8</span>    <span class="mi">894424</span> <span class="mi">20</span>       <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">ESP</span><span class="o">+</span><span class="mi">20</span><span class="p">],</span><span class="n">EAX</span>
<span class="mo">0056005</span><span class="n">C</span>    <span class="n">E8</span> <span class="mo">06040000</span>     <span class="n">CALL</span> <span class="mo">00560467</span> <span class="p">;</span> <span class="n">E553A458</span> <span class="o">=</span> <span class="n">KERNEL32</span><span class="p">.</span><span class="n">VirtualAlloc</span>
<span class="mo">00560061</span>    <span class="n">B9</span> <span class="mf">10E18</span><span class="n">AC3</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="n">C38AE110</span>
<span class="mo">00560066</span>    <span class="mi">8</span><span class="n">BE8</span>            <span class="n">MOV</span> <span class="n">EBP</span><span class="p">,</span><span class="n">EAX</span>
<span class="mo">0056006</span><span class="mi">8</span>    <span class="n">E8</span> <span class="n">FA030000</span>     <span class="n">CALL</span> <span class="mo">00560467</span> <span class="p">;</span> <span class="n">C38AE110</span> <span class="o">=</span> <span class="n">KERNEL32</span><span class="p">.</span><span class="n">VirtualProtect</span>
<span class="mo">0056006</span><span class="n">D</span>    <span class="n">B9</span> <span class="n">AFB15C94</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="mi">945</span><span class="n">CB1AF</span>
<span class="mo">00560072</span>    <span class="mi">894424</span> <span class="mi">2</span><span class="n">C</span>       <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">ESP</span><span class="o">+</span><span class="mi">2</span><span class="n">C</span><span class="p">],</span><span class="n">EAX</span>
<span class="mo">00560076</span>    <span class="n">E8</span> <span class="n">EC030000</span>     <span class="n">CALL</span> <span class="mo">00560467</span> <span class="p">;</span> <span class="mi">945</span><span class="n">CB1AF</span> <span class="o">=</span> <span class="n">ntdll</span><span class="p">.</span><span class="n">ZwFlushInstructionCache</span>
<span class="mo">0056007</span><span class="n">B</span>    <span class="n">B9</span> <span class="mf">33009E95</span>     <span class="n">MOV</span> <span class="n">ECX</span><span class="p">,</span><span class="mf">959E0033</span>
<span class="mo">005600</span><span class="mi">80</span>    <span class="mi">894424</span> <span class="mi">30</span>       <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">ESP</span><span class="o">+</span><span class="mi">30</span><span class="p">],</span><span class="n">EAX</span>
<span class="mo">005600</span><span class="mi">84</span>    <span class="n">E8</span> <span class="n">DE030000</span>     <span class="n">CALL</span> <span class="mo">00560467</span> <span class="p">;</span> <span class="mf">959E0033</span> <span class="o">=</span> <span class="n">KERNELBA</span><span class="p">.</span><span class="n">GetNativeSystemInfo</span>
<span class="mo">005600</span><span class="mi">89</span>    <span class="mi">8</span><span class="n">BD8</span>            <span class="n">MOV</span> <span class="n">EBX</span><span class="p">,</span><span class="n">EAX</span>
<span class="mo">005600</span><span class="mi">8</span><span class="n">B</span>    <span class="mi">8</span><span class="n">B4424</span> <span class="mi">5</span><span class="n">C</span>       <span class="n">MOV</span> <span class="n">EAX</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">ESP</span><span class="o">+</span><span class="mi">5</span><span class="n">C</span><span class="p">]</span>
<span class="mo">005600</span><span class="mi">8</span><span class="n">F</span>    <span class="mi">8</span><span class="n">B78</span> <span class="mi">3</span><span class="n">C</span>         <span class="n">MOV</span> <span class="n">EDI</span><span class="p">,</span><span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">EAX</span><span class="o">+</span><span class="mi">3</span><span class="n">C</span><span class="p">]</span>
<span class="mo">005600</span><span class="mi">92</span>    <span class="mo">03</span><span class="n">F8</span>            <span class="n">ADD</span> <span class="n">EDI</span><span class="p">,</span><span class="n">EAX</span>
<span class="mo">005600</span><span class="mi">94</span>    <span class="mi">897</span><span class="n">C24</span> <span class="mi">10</span>       <span class="n">MOV</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">SS</span><span class="o">:</span><span class="p">[</span><span class="n">ESP</span><span class="o">+</span><span class="mi">10</span><span class="p">],</span><span class="n">EDI</span>
<span class="mo">005600</span><span class="mi">98</span>    <span class="mi">813</span><span class="n">F</span> <span class="mi">50450000</span>   <span class="n">CMP</span> <span class="n">DWORD</span> <span class="n">PTR</span> <span class="n">DS</span><span class="o">:</span><span class="p">[</span><span class="n">EDI</span><span class="p">],</span><span class="mi">4550</span>
</pre></table></code></div></div><p>In the above sample it has pre-encoded strings shown as <code class="language-plaintext highlighter-rouge">726774C</code>, <code class="language-plaintext highlighter-rouge">7802F749</code>, <code class="language-plaintext highlighter-rouge">E553A458</code>, <code class="language-plaintext highlighter-rouge">C38AE110</code>, <code class="language-plaintext highlighter-rouge">945CB1AF</code>, and <code class="language-plaintext highlighter-rouge">959E0033</code>. Once the matching function name (when encoded) matches this it will return the base address to it and store it in the stack for later use.</p><p>It utlimately resolves the following Win32 functions that it will use:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span text-data=" C "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="n">KERNEL32</span><span class="p">.</span><span class="n">LoadLibraryA</span>
<span class="n">KERNEL32</span><span class="p">.</span><span class="n">GetProcAddress</span>
<span class="n">KERNEL32</span><span class="p">.</span><span class="n">VirtualAlloc</span>
<span class="n">KERNEL32</span><span class="p">.</span><span class="n">VirtualProtect</span>
<span class="n">ntdll</span><span class="p">.</span><span class="n">ZwFlushInstructionCache</span>
<span class="n">KERNELBA</span><span class="p">.</span><span class="n">GetNativeSystemInfo</span>
</pre></table></code></div></div><p>These are important and very telling functions that you would want to break and understand what they are loading and or allocating. When you open CFF Explorer on the original file you will not see any of these listed in the Import Address Table (IAT).</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blogging/'>Blogging</a>, <a href='/categories/malware-analysis/'>Malware-Analysis</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/emotet/" class="post-tag no-text-decoration" >emotet</a> <a href="/tags/debugging/" class="post-tag no-text-decoration" >debugging</a> <a href="/tags/ida/" class="post-tag no-text-decoration" >ida</a> <a href="/tags/ghidra/" class="post-tag no-text-decoration" >ghidra</a> <a href="/tags/memory/" class="post-tag no-text-decoration" >memory</a> <a href="/tags/techniques/" class="post-tag no-text-decoration" >techniques</a> <a href="/tags/stack/" class="post-tag no-text-decoration" >stack</a> <a href="/tags/obfuscation/" class="post-tag no-text-decoration" >obfuscation</a> <a href="/tags/ntdll-dll/" class="post-tag no-text-decoration" >ntdll.dll</a> <a href="/tags/kernel32-dll/" class="post-tag no-text-decoration" >kernel32.dll</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=String and function hiding techniques - Travis Mathison&url=https://tdmathison.github.io/posts/String-and-function-hiding-techniques/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://tdmathison.github.io/posts/String-and-function-hiding-techniques/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Hex-Rays-IDA-Tips-and-Tricks/">Hex-Rays IDA Tips and Tricks</a><li><a href="/posts/Npm_Coa_203_DanaBot_Dropper/">NPM COA@2.0.3 DanaBot Dropper</a><li><a href="/posts/MalwareReport-CTS/">Malware Report: CTS</a><li><a href="/posts/Resolving-IAT-with-AGDCservices-scripts/">Resolving IAT with AGDCservices Scripts</a><li><a href="/posts/Finding-the-start-of-Emotet-malware-in-MFC-app/">Finding the start of Emotet malware in MFC app</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/penetration-testing/">penetration-testing</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/exploit-development/">exploit-development</a> <a class="post-tag" href="/tags/ida/">ida</a> <a class="post-tag" href="/tags/shellcode/">shellcode</a> <a class="post-tag" href="/tags/slae32/">slae32</a> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/debugging/">debugging</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Malware-decrypting-into-new-memory-maps/"><div class="card-body"> <span class="timeago small" >Apr 11, 2021<i class="unloaded">2021-04-11T14:29:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Malware decrypting into new memory maps</h3><div class="text-muted small"><p> Table of Contents Intro The malware sample used in this blog post Dealing with decoded bytes into new memory map Memory allocation and passing control Viewing new bytes in ID...</p></div></div></a></div><div class="card"> <a href="/posts/Resolving-IAT-with-AGDCservices-scripts/"><div class="card-body"> <span class="timeago small" >May 25, 2021<i class="unloaded">2021-05-25T11:15:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Resolving IAT with AGDCservices Scripts</h3><div class="text-muted small"><p> Table of Contents Intro Attribution My IDA Pro 7.6 plugin scripts (rough conversion of theirs) Details Color coding instructions IAT Resolution The IDA Pr...</p></div></div></a></div><div class="card"> <a href="/posts/Finding-the-start-of-Emotet-malware-in-MFC-app/"><div class="card-body"> <span class="timeago small" >Apr 7, 2021<i class="unloaded">2021-04-07T13:29:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Finding the start of Emotet malware in MFC app</h3><div class="text-muted small"><p> Intro Sometimes you need to dig a little to really find where the start of malicious code is in a binary. Sometimes it is not obvious from static analysis how exactly code flows to the malicious p...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Malware-decrypting-into-new-memory-maps/" class="btn btn-outline-primary" prompt="Older"><p>Malware decrypting into new memory maps</p></a> <a href="/posts/Resolving-IAT-with-AGDCservices-scripts/" class="btn btn-outline-primary" prompt="Newer"><p>Resolving IAT with AGDCservices Scripts</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://tdmathison.github.io/posts/String-and-function-hiding-techniques/'; this.page.identifier = '/posts/String-and-function-hiding-techniques/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://tdmathison.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (modeToggle !== null) { modeToggle.addEventListener('click', reloadDisqus); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/ciph34block">Travis Mathison</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/penetration-testing/">penetration testing</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/exploit-development/">exploit development</a> <a class="post-tag" href="/tags/ida/">ida</a> <a class="post-tag" href="/tags/shellcode/">shellcode</a> <a class="post-tag" href="/tags/slae32/">slae32</a> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/debugging/">debugging</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-MXD056XG1T"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-MXD056XG1T'); }); </script>
