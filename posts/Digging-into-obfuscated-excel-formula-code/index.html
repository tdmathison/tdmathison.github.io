<!DOCTYPE html><html lang="en" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Digging into obfuscated excel formula code" /><meta name="author" content="Travis Mathison" /><meta property="og:locale" content="en" /><meta name="description" content="Intro A large amount of malware that targets businesses is through phishing attacks, and that is no different where I work. We have been getting an influx of excel attachments in phishing documents and instead of having easy to extract VB macro code it is instead large amounts of obfuscated formula code." /><meta property="og:description" content="Intro A large amount of malware that targets businesses is through phishing attacks, and that is no different where I work. We have been getting an influx of excel attachments in phishing documents and instead of having easy to extract VB macro code it is instead large amounts of obfuscated formula code." /><link rel="canonical" href="https://tdmathison.github.io/posts/Digging-into-obfuscated-excel-formula-code/" /><meta property="og:url" content="https://tdmathison.github.io/posts/Digging-into-obfuscated-excel-formula-code/" /><meta property="og:site_name" content="Travis Mathison" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-02T21:33:00-07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Digging into obfuscated excel formula code" /><meta name="twitter:site" content="@ciph34block" /><meta name="twitter:creator" content="@Travis Mathison" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Travis Mathison"},"description":"Intro A large amount of malware that targets businesses is through phishing attacks, and that is no different where I work. We have been getting an influx of excel attachments in phishing documents and instead of having easy to extract VB macro code it is instead large amounts of obfuscated formula code.","url":"https://tdmathison.github.io/posts/Digging-into-obfuscated-excel-formula-code/","@type":"BlogPosting","headline":"Digging into obfuscated excel formula code","dateModified":"2020-12-02T12:14:03-08:00","datePublished":"2020-10-02T21:33:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://tdmathison.github.io/posts/Digging-into-obfuscated-excel-formula-code/"},"@context":"https://schema.org"}</script><title>Digging into obfuscated excel formula code | Travis Mathison</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Travis Mathison"><meta name="application-name" content="Travis Mathison"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/profile.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Travis Mathison</a></div><div class="site-subtitle font-italic">Malware Reverse Engineering and Threat Research.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/resources/" class="nav-link"> <i class="fa-fw fas fa-book ml-xl-3 mr-xl-3 unloaded"></i> <span>RESOURCES</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/tdmathison" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/ciph34block" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://www.linkedin.com/in/travismathison/" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Digging into obfuscated excel formula code</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Digging into obfuscated excel formula code</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Travis Mathison </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Oct 2, 2020, 9:33 PM -0700" >Oct 2, 2020<i class="unloaded">2020-10-02T21:33:00-07:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Dec 2, 2020, 12:14 PM -0800" >Dec 2, 2020<i class="unloaded">2020-12-02T12:14:03-08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1339 words">7 min read</span></div></div><div class="post-content"><h2 id="intro">Intro</h2><p>A large amount of malware that targets businesses is through phishing attacks, and that is no different where I work. We have been getting an influx of excel attachments in phishing documents and instead of having easy to extract VB macro code it is instead large amounts of obfuscated formula code.</p><p>This post is specifically to talk about some static analysis performed at that stage of the analysis and the custom python I wrote in an attempt to get some insight into what it may be doing.</p><h2 id="the-sample-and-supporting-code">The sample and supporting code</h2><p>I have uploaded the sample to VirusTotal and have created a GitHub repository with the python code discussed here and example output.</p><p><strong>VirusTotal:</strong><br /> <a href="https://www.virustotal.com/gui/file/0aae8be1164f7c19c2c7215030b907d1ddefb186b7da77687ddccc4731267474/detection">https://www.virustotal.com/gui/file/0aae8be1164f7c19c2c7215030b907d1ddefb186b7da77687ddccc4731267474/detection</a></p><p><strong>GitHub:</strong><br /> <a href="https://github.com/tdmathison/ExcelFormulaExtractor">https://github.com/tdmathison/ExcelFormulaExtractor</a></p><h2 id="password-protected-excel-workbook">Password protected excel workbook</h2><p>Before looking at the code there are two things that may be pitfalls. First is that in this case the excel sheet is password protected (but we have the password as it was given in the phishing email it came from), secondly, when you export excel tabs to CSV files you may “lose data” if not careful.</p><h3 id="removing-password-protection-from-excel-document">Removing password protection from excel document</h3><p>To remove password protection on the excel document you can utilize the <a href="https://blog.didierstevens.com/2018/12/31/new-tool-msoffcrypto-crack-py/">msoffcrypto-crack.py</a> script. This is installed and ready for use within the FireEye FlareVM.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>pass.txt contains:
F0409!

Command:
PS C:\Users\flarevm\Desktop\6050874161397760&gt; &amp; 'C:\Python27\python.exe' C:\Tools\msoffcrypto-crack\msoffcrypto-crack.py -p .\pass.txt -o decrypted.xls .\sample.xls
Password found: F0409!
</pre></table></code></div></div><p>This will create a new file called decrypted.xls that will no longer prompt for a password.</p><h3 id="exporting-excel-workbook-tabs-as-csv-files">Exporting excel workbook tabs as CSV files</h3><p>To export tabs to CSV files you simply need to:</p><ul><li>Select the tab you want to export<li>Select File-&gt;Export-&gt;Change File Type and select “CSV (Comma delimited)(*.csv)</ul><p><strong>The catch:</strong><br /> In the case of formulas that reference specific columns and rows we need to preserve this in the exported data. When you export you may LOSE this data by excel eliminating many columns or rows that did not contain data. Formulas in malware often embed themselves dozens or hundreds of columns deep.</p><p><strong>The solution:</strong><br /> All you need to do is enter a single value into the A1 cell. Just enter the number “1” before performing the export to CSV and it will capture the complete document and preserve the columns and rows needed for analysis.</p><h2 id="observing-the-malwares-formula-code">Observing the malwares formula code</h2><p>When observing the Name Manager in the excel book I saw an Auto_Open value that refered to =I!$CS$25895 and this is where I saw the initial formula code which I quickly realized was obfuscated to make it difficult to make sense of.</p><p><img data-proofer-ignore data-src="https://tdmathison.github.io/assets/img/blogging/excel_01.png" /></p><p>Following the formula code jumping around shows how painful this would be to manually attempt to follow.</p><p><img data-proofer-ignore data-src="https://tdmathison.github.io/assets/img/blogging/excel_02.png" /></p><h2 id="the-programatic-solution">The programatic solution</h2><p>In an attempt to solve this problem I had two specific requirements:<br /> 1) Since specific cells were referenced by name such as $AB$50741 I needed to make sure I built a table were they could be referenced<br /> 2) I needed a way to start with a value in a given cell and then merge the content into the string by replacing the cell location text</p><p>All that would be left is applying step 2 over and over until there are no more cell location strings to replace.</p><h3 id="dumping-content-into-hashmap">Dumping content into hashmap</h3><p>The first part is achieved by creating a hashmap and reading through all delimited data and adding it to the hashmap with the key being the formatted location of the cell that would be referenced in the formula code.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="n">excel_data</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Locates all excel sheet cells with data and saves the cell location as a key and the content as the value
</span><span class="k">def</span> <span class="nf">dump_excel_sheet_values</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">row_values</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">row_values</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">col_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
                <span class="n">value_to_save</span> <span class="o">=</span> <span class="n">col_value</span><span class="p">.</span><span class="n">strip</span><span class="p">().</span><span class="n">replace</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span> <span class="s">'</span><span class="se">\\</span><span class="s">n'</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value_to_save</span><span class="p">:</span>
                    <span class="n">excel_data</span><span class="p">[</span><span class="nb">str</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="s">"${}${}"</span><span class="p">,</span> <span class="n">get_col_name</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">row</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">value_to_save</span>

<span class="n">dump_excel_sheet_values</span><span class="p">(</span><span class="n">sys</span><span class="p">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></table></code></div></div><p>With this we can dump out the content and display the proper cell location as shown in the partial snippet below:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>$A$1: 1
$BM$65: 19053
$BM$66: 40
$HC$292: i
$AH$462: a
$HE$736: w
$AR$982: J
$AC$1180: h
$DP$1387: d
$DV$1540: Y
$FS$1919: P
$IM$2401: Y
$DS$2454: e
$FO$2480: N
$DX$2684: EsNDtISBBnaCXk=$HF$26301&amp;$EB$37517&amp;$Y$59856&amp;$H$23233&amp;$FR$26455&amp;$BK$49458&amp;$P$23617&amp;$FU$38413&amp;$G$15199&amp;$DF$13040
$DX$2685: ygxjnNCysLIfB=$GC$31380
$DX$2686: =$ER$4739()
$DX$2687: =RUN($AX$7390)
</pre></table></code></div></div><h3 id="reconstructing-the-formula-strings-into-something-useful">Reconstructing the formula strings into something useful</h3><p>The final step is to take all of these obfuscated strings and merge in the content of all the cell location references. I made a simple function that will do this for the first cell location is find (via regex search). In the end, this function just gets applied to the string over and over until it can no longer find any more references to other cells.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c1"># Checks if the string concatenates other cell data and merges the first occurrence in
</span><span class="k">def</span> <span class="nf">reconstruct</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">re</span><span class="p">.</span><span class="n">search</span><span class="p">(</span><span class="n">regexp_cell_pos</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">data_modified</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">result</span><span class="p">.</span><span class="n">start</span><span class="p">()]</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">result</span><span class="p">.</span><span class="n">start</span><span class="p">():</span> <span class="n">result</span><span class="p">.</span><span class="n">end</span><span class="p">()]</span> <span class="ow">in</span> <span class="n">excel_data</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1"># merge in the content from the referenced cell
</span>            <span class="n">data_modified</span> <span class="o">+=</span> <span class="n">excel_data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">result</span><span class="p">.</span><span class="n">start</span><span class="p">():</span> <span class="n">result</span><span class="p">.</span><span class="n">end</span><span class="p">()]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># blank cell that is used to store values at runtime
</span>            <span class="n">data_modified</span> <span class="o">+=</span> <span class="s">'(var-cell)'</span>

        <span class="n">data_modified</span> <span class="o">+=</span> <span class="n">data</span><span class="p">[</span><span class="n">result</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

        <span class="k">return</span> <span class="n">repair</span><span class="p">(</span><span class="n">data_modified</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">None</span>
</pre></table></code></div></div><p>Finally, we loop through every key we populated and see how much it can merge together. Some cells are just single characters that are used to concatenate text together and some cells make 10+ cell references.</p><div class="language-python highlighter-rouge"><div class="code-header"> <span text-data=" Python "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1"># Run through each key and attempt to reconstruct
</span><span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">excel_data</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Initial: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">excel_data</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>

    <span class="n">new_val</span> <span class="o">=</span> <span class="n">reconstruct</span><span class="p">(</span><span class="n">excel_data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="n">new_string</span> <span class="o">=</span> <span class="n">new_val</span>

    <span class="k">while</span> <span class="n">new_val</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">new_val</span><span class="p">)</span>
        <span class="n">new_string</span> <span class="o">=</span> <span class="n">new_val</span>
        <span class="n">new_val</span> <span class="o">=</span> <span class="n">reconstruct</span><span class="p">(</span><span class="n">new_string</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">new_string</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">new_string</span> <span class="o">!=</span> <span class="s">'(var-cell)'</span><span class="p">):</span>
        <span class="n">final_strings</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_string</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">"Final: {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">new_string</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"********************************************************"</span><span class="p">)</span>
</pre></table></code></div></div><h3 id="results">Results</h3><p>The resulting output is very large so an couple examples of where the value came out of this are:</p><p><strong>Showing it resolve a Win32 function</strong></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>Initial: =RUN($II$26959)
=RUN(EsNDtISBBnaCXk=$EI$48049&amp;$U$22638&amp;$EO$25738&amp;$FR$34525&amp;$AP$37942&amp;$B$6338&amp;$CQ$36635&amp;$DS$2454&amp;$AW$53450&amp;$DA$9220&amp;$FX$55530&amp;$DO$26222&amp;$CV$8941
=RUN(EsNDtISBBnaCXk=S$U$22638&amp;$EO$25738&amp;$FR$34525&amp;$AP$37942&amp;$B$6338&amp;$CQ$36635&amp;$DS$2454&amp;$AW$53450&amp;$DA$9220&amp;$FX$55530&amp;$DO$26222&amp;$CV$8941
=RUN(EsNDtISBBnaCXk=Sh$EO$25738&amp;$FR$34525&amp;$AP$37942&amp;$B$6338&amp;$CQ$36635&amp;$DS$2454&amp;$AW$53450&amp;$DA$9220&amp;$FX$55530&amp;$DO$26222&amp;$CV$8941
=RUN(EsNDtISBBnaCXk=She$FR$34525&amp;$AP$37942&amp;$B$6338&amp;$CQ$36635&amp;$DS$2454&amp;$AW$53450&amp;$DA$9220&amp;$FX$55530&amp;$DO$26222&amp;$CV$8941
=RUN(EsNDtISBBnaCXk=Shel$AP$37942&amp;$B$6338&amp;$CQ$36635&amp;$DS$2454&amp;$AW$53450&amp;$DA$9220&amp;$FX$55530&amp;$DO$26222&amp;$CV$8941
=RUN(EsNDtISBBnaCXk=Shell$B$6338&amp;$CQ$36635&amp;$DS$2454&amp;$AW$53450&amp;$DA$9220&amp;$FX$55530&amp;$DO$26222&amp;$CV$8941
=RUN(EsNDtISBBnaCXk=ShellE$CQ$36635&amp;$DS$2454&amp;$AW$53450&amp;$DA$9220&amp;$FX$55530&amp;$DO$26222&amp;$CV$8941
=RUN(EsNDtISBBnaCXk=ShellEx$DS$2454&amp;$AW$53450&amp;$DA$9220&amp;$FX$55530&amp;$DO$26222&amp;$CV$8941
=RUN(EsNDtISBBnaCXk=ShellExe$AW$53450&amp;$DA$9220&amp;$FX$55530&amp;$DO$26222&amp;$CV$8941
=RUN(EsNDtISBBnaCXk=ShellExec$DA$9220&amp;$FX$55530&amp;$DO$26222&amp;$CV$8941
=RUN(EsNDtISBBnaCXk=ShellExecu$FX$55530&amp;$DO$26222&amp;$CV$8941
=RUN(EsNDtISBBnaCXk=ShellExecut$DO$26222&amp;$CV$8941
=RUN(EsNDtISBBnaCXk=ShellExecute$CV$8941
=RUN(EsNDtISBBnaCXk=ShellExecuteA
Final: =RUN(EsNDtISBBnaCXk=ShellExecuteA
</pre></table></code></div></div><p><strong>Showing it resolve the C&amp;C URL</strong><br /> <em>NOTE: I have intentionally broken the link text formulated below.</em></p><div class="language-text highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre>Initial: EsNDtISBBnaCXk=$W$27806&amp;$DB$48425&amp;$CG$29888&amp;$GH$57090&amp;$EK$3388&amp;$BT$55498&amp;$IL$29507&amp;$CR$10941&amp;$U$21547&amp;$GY$4902&amp;$AE$53306&amp;$BX$30413&amp;$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=h$DB$48425&amp;$CG$29888&amp;$GH$57090&amp;$EK$3388&amp;$BT$55498&amp;$IL$29507&amp;$CR$10941&amp;$U$21547&amp;$GY$4902&amp;$AE$53306&amp;$BX$30413&amp;$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=ht$CG$29888&amp;$GH$57090&amp;$EK$3388&amp;$BT$55498&amp;$IL$29507&amp;$CR$10941&amp;$U$21547&amp;$GY$4902&amp;$AE$53306&amp;$BX$30413&amp;$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=htt$GH$57090&amp;$EK$3388&amp;$BT$55498&amp;$IL$29507&amp;$CR$10941&amp;$U$21547&amp;$GY$4902&amp;$AE$53306&amp;$BX$30413&amp;$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=http$EK$3388&amp;$BT$55498&amp;$IL$29507&amp;$CR$10941&amp;$U$21547&amp;$GY$4902&amp;$AE$53306&amp;$BX$30413&amp;$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https$BT$55498&amp;$IL$29507&amp;$CR$10941&amp;$U$21547&amp;$GY$4902&amp;$AE$53306&amp;$BX$30413&amp;$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https:$IL$29507&amp;$CR$10941&amp;$U$21547&amp;$GY$4902&amp;$AE$53306&amp;$BX$30413&amp;$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https:/$CR$10941&amp;$U$21547&amp;$GY$4902&amp;$AE$53306&amp;$BX$30413&amp;$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://$U$21547&amp;$GY$4902&amp;$AE$53306&amp;$BX$30413&amp;$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://c$GY$4902&amp;$AE$53306&amp;$BX$30413&amp;$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://co$AE$53306&amp;$BX$30413&amp;$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://com$BX$30413&amp;$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://comp$FG$27124&amp;$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://compo$BV$30953&amp;$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://compon$IM$56694&amp;$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://compone$EV$38328&amp;$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://componen$CF$15512&amp;$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component$EG$30041&amp;$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component.$DZ$15836&amp;$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component.p$ET$32765&amp;$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw$CQ$47333&amp;$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/$HE$736&amp;$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/w$V$24861&amp;$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/wp$DP$11026&amp;$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/wp-$FA$21247&amp;$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/wp-i$CD$7333&amp;$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/wp-in$AK$10221&amp;$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/wp-ind$HH$23769&amp;$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/wp-inde$DK$39723&amp;$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/wp-index$BH$15533&amp;$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/wp-index.$AC$35202&amp;$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/wp-index.p$CT$11282&amp;$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/wp-index.ph$EY$36257
EsNDtISBBnaCXk=https ://component[.]pw/wp-index.php
Final: EsNDtISBBnaCXk=https ://component[.]pw/wp-index.php
</pre></table></code></div></div><p>At the end, a dump of the final text strings are listed. This is where you can find IoC’s, Win32 calls, paths to executables that may be dropped, the C&amp;C path that we see here (and I verified it calls out to with FakeNet running).</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span text-data=" Text "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>Final strings list:
===========================================
EsNDtISBBnaCXk=C:\jhmKRYC
ygxjnNCysLIfB=(var-cell)
="=RETURN(FORMULA.FILL(EsNDtISBBnaCXk)
=RUN(EsNDtISBBnaCXk=C:\jhmKRYC\POeikcC
EsNDtISBBnaCXk=cmhKasNg
ygxjnNCysLIfB=(var-cell)
="=RETURN(FORMULA.FILL(EsNDtISBBnaCXk)
=RUN(EsNDtISBBnaCXk=dTyIIHMw
EsNDtISBBnaCXk=CreateDirectoryA
EsNDtISBBnaCXk=Shell32
=RUN(EsNDtISBBnaCXk=ShellExecuteA
EsNDtISBBnaCXk=C:\jhmKRYC\POeikcC
EsNDtISBBnaCXk=DownloadFile
=RUN(EsNDtISBBnaCXk=C:\jhmKRYC\POeikcC\XqwFtZi.exe

... and more
</pre></table></code></div></div><h2 id="conclusion">Conclusion</h2><p>This was an exercise to see how much I could learn from this formula code through static analysis. Many of the findings from above were observed during dynamic analysis but not all. The more information you have before dynamic analysis the more you can knowingly watch out for and attempt to observe. The downside of dynamic analysis is that you only see the path the malware takes during that detonation and you may miss a lot of what the malware could potentially do.</p><p>Full code to above project is in the <a href="https://github.com/tdmathison/ExcelFormulaExtractor">https://github.com/tdmathison/ExcelFormulaExtractor</a> repo.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blogging/'>Blogging</a>, <a href='/categories/malware-analysis/'>Malware-Analysis</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/malware/" class="post-tag no-text-decoration" >malware</a> <a href="/tags/excel/" class="post-tag no-text-decoration" >excel</a> <a href="/tags/scripts/" class="post-tag no-text-decoration" >scripts</a> <a href="/tags/macros/" class="post-tag no-text-decoration" >macros</a> <a href="/tags/phishing/" class="post-tag no-text-decoration" >phishing</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Digging into obfuscated excel formula code - Travis Mathison&url=https://tdmathison.github.io/posts/Digging-into-obfuscated-excel-formula-code/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://tdmathison.github.io/posts/Digging-into-obfuscated-excel-formula-code/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Hex-Rays-IDA-Tips-and-Tricks/">Hex-Rays IDA Tips and Tricks</a><li><a href="/posts/Npm_Coa_203_DanaBot_Dropper/">NPM COA@2.0.3 DanaBot Dropper</a><li><a href="/posts/MalwareReport-CTS/">Malware Report: CTS</a><li><a href="/posts/Resolving-IAT-with-AGDCservices-scripts/">Resolving IAT with AGDCservices Scripts</a><li><a href="/posts/Finding-the-start-of-Emotet-malware-in-MFC-app/">Finding the start of Emotet malware in MFC app</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/penetration-testing/">penetration-testing</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/exploit-development/">exploit-development</a> <a class="post-tag" href="/tags/ida/">ida</a> <a class="post-tag" href="/tags/shellcode/">shellcode</a> <a class="post-tag" href="/tags/slae32/">slae32</a> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/debugging/">debugging</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/PEB_TEB_TIB-Structure-Offsets/"><div class="card-body"> <span class="timeago small" >Feb 5, 2021<i class="unloaded">2021-02-05T11:10:00-08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>PEB/TEB/TIB Structure Offsets</h3><div class="text-muted small"><p> Intro This is really more of a reference table post to show the PEB/TEB/TIB structure notable offsets that are commonly seen in malware as it performs references after fetching the Process Environm...</p></div></div></a></div><div class="card"> <a href="/posts/Searching-IAT-for-DLL/"><div class="card-body"> <span class="timeago small" >Mar 29, 2021<i class="unloaded">2021-03-29T10:34:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Searching IAT for DLLs</h3><div class="text-muted small"><p> Intro With a given binary it is very simple to view the Import Address Table (IAT) and see what DLLs it imports and further, what functions are used within those DLLs. In my case, I needed to do t...</p></div></div></a></div><div class="card"> <a href="/posts/Finding-the-start-of-Emotet-malware-in-MFC-app/"><div class="card-body"> <span class="timeago small" >Apr 7, 2021<i class="unloaded">2021-04-07T13:29:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Finding the start of Emotet malware in MFC app</h3><div class="text-muted small"><p> Intro Sometimes you need to dig a little to really find where the start of malicious code is in a binary. Sometimes it is not obvious from static analysis how exactly code flows to the malicious p...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Ghidra-DIA-SDK-PDB-Error/" class="btn btn-outline-primary" prompt="Older"><p>Ghidra error: Unable to locate the DIA SDK</p></a> <a href="/posts/Manually-unpacking-malware/" class="btn btn-outline-primary" prompt="Newer"><p>Manually Unpacking Malware</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://tdmathison.github.io/posts/Digging-into-obfuscated-excel-formula-code/'; this.page.identifier = '/posts/Digging-into-obfuscated-excel-formula-code/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver(function (entries) { if(entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://tdmathison.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] }); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { /* Disqus hasn't been loaded */ if (typeof DISQUS === "undefined") { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } const modeToggle = document.querySelector(".mode-toggle"); if (modeToggle !== null) { modeToggle.addEventListener('click', reloadDisqus); window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', reloadDisqus); } </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/ciph34block">Travis Mathison</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/hacking/">hacking</a> <a class="post-tag" href="/tags/malware/">malware</a> <a class="post-tag" href="/tags/penetration-testing/">penetration testing</a> <a class="post-tag" href="/tags/assembly/">assembly</a> <a class="post-tag" href="/tags/exploit-development/">exploit development</a> <a class="post-tag" href="/tags/ida/">ida</a> <a class="post-tag" href="/tags/shellcode/">shellcode</a> <a class="post-tag" href="/tags/slae32/">slae32</a> <a class="post-tag" href="/tags/x86/">x86</a> <a class="post-tag" href="/tags/debugging/">debugging</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-MXD056XG1T"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-MXD056XG1T'); }); </script>
